4c795fec7eea899de63cfcffcef467ed
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var EmailService_1;
var _a, _b, _c, _d, _e, _f;
Object.defineProperty(exports, "__esModule", { value: true });
exports.EmailService = void 0;
/**
 * EmailService provides logic for sending emails, managing preferences, analytics, and tracking.
 */
const common_1 = require("@nestjs/common");
const typeorm_1 = require("@nestjs/typeorm");
const typeorm_2 = require("typeorm");
const bull_1 = require("@nestjs/bull");
const bull_2 = require("bull");
const config_1 = require("@nestjs/config");
const nodemailer = __importStar(require("nodemailer"));
const Handlebars = __importStar(require("handlebars"));
const fs = __importStar(require("fs"));
const path = __importStar(require("path"));
const email_template_entity_1 = require("./entities/email-template.entity");
const email_log_entity_1 = require("./entities/email-log.entity");
const email_preference_entity_1 = require("./entities/email-preference.entity");
const tracking_util_1 = require("./utils/tracking.util");
const jwt_1 = require("@nestjs/jwt");
var EmailType;
(function (EmailType) {
    EmailType["VERIFICATION"] = "email-verification";
    EmailType["ENROLLMENT"] = "course-enrollment";
    EmailType["COMPLETION"] = "course-completion";
    EmailType["FORUM"] = "forum-notification";
})(EmailType || (EmailType = {}));
let EmailService = EmailService_1 = class EmailService {
    constructor(configService, emailQueue, emailTemplateRepository, emailLogRepository, emailPreferenceRepository, jwtService) {
        this.configService = configService;
        this.emailQueue = emailQueue;
        this.emailTemplateRepository = emailTemplateRepository;
        this.emailLogRepository = emailLogRepository;
        this.emailPreferenceRepository = emailPreferenceRepository;
        this.jwtService = jwtService;
        this.logger = new common_1.Logger(EmailService_1.name);
        this.initializeTransporter();
    }
    /**
     * Initialize the nodemailer transporter using config values.
     */
    initializeTransporter() {
        this.transporter = nodemailer.createTransport({
            host: this.configService.get('EMAIL_HOST'),
            port: this.configService.get('EMAIL_PORT'),
            secure: this.configService.get('EMAIL_SECURE', false),
            auth: {
                user: this.configService.get('EMAIL_USER'),
                pass: this.configService.get('EMAIL_PASSWORD'),
            },
        });
    }
    /**
     * Send an email using the specified options. Queues the email for sending.
     * @param options - Email options
     * @returns True if the email was successfully queued, false otherwise
     */
    async sendEmail(options) {
        const emailEnabled = this.configService.get('EMAIL_ENABLED');
        if (emailEnabled === 'false' || emailEnabled === '0') {
            this.logger.log('Email sending is disabled by EMAIL_ENABLED flag. Skipping email.');
            return false;
        }
        try {
            if (await this.hasUserOptedOut(options.to, options.templateName)) {
                this.logger.log(`User ${options.to} has opted out of ${options.templateName} emails`);
                return false;
            }
            await this.emailQueue.add('send', options, {
                attempts: 3,
                backoff: {
                    type: 'exponential',
                    delay: 5000,
                },
            });
            return true;
        }
        catch (error) {
            this.logger.error(`Failed to queue email: ${error.message}`, error.stack);
            return false;
        }
    }
    /**
     * Send an email immediately using the specified options. Bypasses the queue.
     * @param options - Email options
     * @returns True if the email was successfully sent, false otherwise
     */
    async sendImmediate(options) {
        const emailEnabled = this.configService.get('EMAIL_ENABLED');
        if (emailEnabled === 'false' || emailEnabled === '0') {
            this.logger.log('Email sending is disabled by EMAIL_ENABLED flag. Skipping immediate email.');
            return false;
        }
        try {
            const template = await this.getTemplate(options.templateName);
            const compiledTemplate = Handlebars.compile(template);
            let html = compiledTemplate(options.context);
            const emailId = (0, tracking_util_1.generateEmailId)();
            if (!options.skipTracking) {
                const baseUrl = this.configService.get('BASE_URL');
                html = (0, tracking_util_1.addTrackingToEmail)(html, emailId, baseUrl);
            }
            const mailOptions = {
                from: this.configService.get('EMAIL_FROM'),
                to: options.to,
                cc: options.cc,
                bcc: options.bcc,
                subject: options.subject,
                html,
                attachments: options.attachments || [],
            };
            const info = await this.transporter.sendMail(mailOptions);
            await this.logEmail({
                id: emailId,
                recipient: Array.isArray(options.to) ? options.to.join(', ') : options.to,
                subject: options.subject,
                templateName: options.templateName,
                messageId: info.messageId,
                status: 'sent',
                // tracking
                trackingEnabled: !options.skipTracking,
                trackingToken: !options.skipTracking ? emailId : null,
            });
            return true;
        }
        catch (error) {
            this.logger.error(`Failed to send email: ${error.message}`, error.stack);
            await this.logEmail({
                recipient: Array.isArray(options.to) ? options.to.join(', ') : options.to,
                subject: options.subject,
                templateName: options.templateName,
                status: 'failed',
                error: error.message,
            });
            return false;
        }
    }
    /**
     * Get the email template content by name. First checks the database, then falls back to file system.
     * @param templateName - Name of the template
     * @returns The template content
     */
    async getTemplate(templateName) {
        const dbTemplate = await this.emailTemplateRepository.findOne({ where: { name: templateName } });
        if (dbTemplate)
            return dbTemplate.content;
        const templatePath = path.join(process.cwd(), 'src/email/templates', `${templateName}.hbs`);
        return fs.readFileSync(templatePath, 'utf8');
    }
    /**
     * Log an email event to the database.
     * @param logData - Partial email log data
     */
    async logEmail(logData) {
        const log = this.emailLogRepository.create(logData);
        await this.emailLogRepository.save(log);
    }
    /**
     * Check if a user has opted out of a specific email type.
     * @param recipient - Recipient email address
     * @param templateType - Email template type
     * @returns True if the user has opted out, false otherwise
     */
    async hasUserOptedOut(recipient, templateType) {
        if (Array.isArray(recipient)) {
            for (const email of recipient) {
                const preference = await this.emailPreferenceRepository.findOne({ where: { email, optOut: true } });
                if (preference)
                    return true;
            }
            return false;
        }
        const preference = await this.emailPreferenceRepository.findOne({ where: { email: recipient, optOut: true } });
        return !!preference;
    }
    /**
     * Update a user's email preference for a specific email type.
     * @param email - User email address
     * @param emailType - Type of email
     * @param optOut - Whether the user opts out
     * @returns The updated EmailPreference entity
     */
    async updateEmailPreference(email, emailType, optOut) {
        let preference = await this.emailPreferenceRepository.findOne({ where: { email } });
        if (preference) {
            preference.optOut = optOut;
        }
        else {
            preference = this.emailPreferenceRepository.create({ email, optOut });
        }
        return this.emailPreferenceRepository.save(preference);
    }
    /**
     * Get email analytics for a date range and optional template name.
     * @param startDate - Start date
     * @param endDate - End date
     * @param templateName - Optional template name
     * @returns Analytics data
     */
    async getEmailAnalytics(startDate, endDate, templateName) {
        const query = this.emailLogRepository
            .createQueryBuilder('log')
            .select('log.templateName', 'templateName')
            .addSelect('COUNT(*)', 'count')
            .addSelect('log.status', 'status')
            .where('log.createdAt BETWEEN :startDate AND :endDate', { startDate, endDate })
            .groupBy('log.templateName')
            .addGroupBy('log.status');
        if (templateName) {
            query.andWhere('log.templateName = :templateName', { templateName });
        }
        return query.getRawMany();
    }
    /**
     * Send a verification email to the user.
     * @param user - User object
     * @param verificationCode - Verification code
     * @param verificationToken - Verification token
     * @returns True if the email was successfully sent, false otherwise
     */
    async sendVerificationEmail(user, verificationCode, verificationToken) {
        const verificationUrl = `${this.configService.get('FRONTEND_URL')}/verify-email?token=${verificationToken}`;
        const unsubscribeUrl = `${this.configService.get('FRONTEND_URL')}/preferences?email=${user.email}`;
        return this.sendEmail({
            to: user.email,
            subject: 'Verify Your Email Address',
            templateName: 'email-verification',
            context: {
                name: user.name,
                verificationUrl,
                verificationCode,
                expiryTime: 24,
                unsubscribeUrl,
                year: new Date().getFullYear(),
            },
        });
    }
    /**
     * Send a course enrollment email to the user.
     * @param user - User object
     * @param course - Course object
     * @returns True if the email was successfully sent, false otherwise
     */
    async sendCourseEnrollmentEmail(user, course) {
        const courseUrl = `${this.configService.get('FRONTEND_URL')}/courses/${course.id}`;
        const unsubscribeUrl = `${this.configService.get('FRONTEND_URL')}/preferences?email=${user.email}`;
        return this.sendEmail({
            to: user.email,
            subject: `Enrollment Confirmation: ${course.name}`,
            templateName: 'course-enrollment',
            context: {
                name: user.name,
                courseName: course.name,
                instructorName: course.instructor.name,
                startDate: new Date(course.startDate).toLocaleDateString(),
                duration: course.duration,
                courseUrl,
                unsubscribeUrl,
                year: new Date().getFullYear(),
            },
        });
    }
    /**
     * Send a course completion email to the user.
     * @param user - User object
     * @param course - Course object
     * @param score - Completion score
     * @returns True if the email was successfully sent, false otherwise
     */
    async sendCourseCompletionEmail(user, course, score) {
        const certificateUrl = `${this.configService.get('FRONTEND_URL')}/certificates/${course.id}`;
        const courseCatalogUrl = `${this.configService.get('FRONTEND_URL')}/courses`;
        const unsubscribeUrl = `${this.configService.get('FRONTEND_URL')}/preferences?email=${user.email}`;
        return this.sendEmail({
            to: user.email,
            subject: `Congratulations on Completing ${course.name}!`,
            templateName: 'course-completion',
            context: {
                name: user.name,
                courseName: course.name,
                score,
                completionDate: new Date().toLocaleDateString(),
                certificateUrl,
                courseCatalogUrl,
                unsubscribeUrl,
                year: new Date().getFullYear(),
            },
        });
    }
    /**
     * Send a forum notification email to the user.
     * @param user - User object
     * @param notification - Notification object
     * @returns True if the email was successfully sent, false otherwise
     */
    async sendForumNotificationEmail(user, notification) {
        const postUrl = `${this.configService.get('FRONTEND_URL')}/forum/posts/${notification.postId}`;
        const unsubscribeUrl = `${this.configService.get('FRONTEND_URL')}/preferences?email=${user.email}`;
        return this.sendEmail({
            to: user.email,
            subject: `Forum Notification: ${notification.type}`,
            templateName: 'forum-notification',
            context: {
                name: user.name,
                notificationType: notification.type,
                notificationMessage: notification.message,
                postAuthor: notification.post.author.name,
                postDate: new Date(notification.post.createdAt).toLocaleDateString(),
                postContent: notification.post.content,
                postUrl,
                unsubscribeUrl,
                year: new Date().getFullYear(),
            },
        });
    }
    /**
     * Mark an email as clicked by its log ID.
     * @param id - Email log ID
     * @param url - URL that was clicked
     */
    async markEmailAsClicked(trackingToken, url, metadata) {
        const emailLog = await this.emailLogRepository.findOne({ where: { trackingToken } });
        if (!emailLog) {
            throw new common_1.NotFoundException('Email tracking token not found');
        }
        const now = new Date();
        const events = Array.isArray(emailLog.clickEvents) ? emailLog.clickEvents.slice() : [];
        events.push({
            clickedAt: now.toISOString(),
            url,
            userAgent: metadata?.userAgent,
            ipAddress: metadata?.ipAddress,
        });
        const updates = {
            clickCount: (emailLog.clickCount || 0) + 1,
            clickEvents: events,
        };
        if (!emailLog.firstClickedAt) {
            updates.firstClickedAt = now;
        }
        await this.emailLogRepository.update({ id: emailLog.id }, updates);
        this.logger.log(`Email link clicked: ${trackingToken} -> ${url}`);
    }
    /**
     * Mark an email as opened by its log ID.
     * @param id - Email log ID
     */
    async markEmailAsOpened(trackingToken, metadata) {
        const emailLog = await this.emailLogRepository.findOne({ where: { trackingToken } });
        if (!emailLog) {
            throw new common_1.NotFoundException('Email tracking token not found');
        }
        const now = new Date();
        const updates = {
            openedAt: now,
            openCount: (emailLog.openCount || 0) + 1,
        };
        if (!emailLog.firstOpenedAt) {
            updates.firstOpenedAt = now;
        }
        await this.emailLogRepository.update({ id: emailLog.id }, updates);
        this.logger.log(`Email opened: ${trackingToken}`);
    }
    /**
     * Get analytics for a specific email log
     */
    async getEmailAnalytics(emailId) {
        const emailLog = await this.emailLogRepository.findOne({ where: { id: emailId } });
        if (!emailLog) {
            throw new common_1.NotFoundException('Email not found');
        }
        return {
            id: emailLog.id,
            to: emailLog.recipient,
            subject: emailLog.subject,
            sentAt: emailLog.createdAt,
            opened: !!emailLog.firstOpenedAt,
            openedAt: emailLog.firstOpenedAt,
            openCount: emailLog.openCount || 0,
            clicked: !!emailLog.firstClickedAt,
            firstClickedAt: emailLog.firstClickedAt,
            clickCount: emailLog.clickCount || 0,
            clicks: emailLog.clickEvents || [],
        };
    }
    /**
     * Verify the unsubscribe token for a given email.
     * @param email - User email address
     * @param token - Unsubscribe token
     * @returns True if the token is valid, false otherwise
     */
    async verifyUnsubscribeToken(email, token) {
        try {
            const secret = this.configService.get('UNSUBSCRIBE_JWT_SECRET') || this.configService.get('JWT_SECRET');
            const payload = (this.jwtService
                ? this.jwtService.verify(token, { secret })
                : (await Promise.resolve().then(() => __importStar(require('jsonwebtoken')))).verify(token, secret));
            return !!payload && (payload.email === email || payload.sub === email);
        }
        catch (err) {
            this.logger.warn(`Invalid unsubscribe token for ${email}: ${err?.message}`);
            return false;
        }
    }
    /**
     * Get daily email statistics for a date range and optional template name.
     * @param start - Start date
     * @param end - End date
     * @param templateName - Optional template name
     * @returns Daily email statistics
     */
    async getDailyEmailStats(start, end, templateName) {
        // Implement your logic here or return a mock for now
        return [];
    }
    /**
     * Get the user's email preferences for all email types.
     * @param email - User email address
     * @returns Array of email preferences
     */
    async getUserPreferences(email) {
        const preferences = await this.emailPreferenceRepository.find({ where: { email } });
        return Object.values(EmailType).map((type) => {
            const preference = preferences.find((p) => p.email === email && p.optOut);
            return {
                emailType: type,
                optedOut: !!preference,
            };
        });
    }
};
exports.EmailService = EmailService;
exports.EmailService = EmailService = EmailService_1 = __decorate([
    (0, common_1.Injectable)(),
    __param(1, (0, bull_1.InjectQueue)('email')),
    __param(2, (0, typeorm_1.InjectRepository)(email_template_entity_1.EmailTemplate)),
    __param(3, (0, typeorm_1.InjectRepository)(email_log_entity_1.EmailLog)),
    __param(4, (0, typeorm_1.InjectRepository)(email_preference_entity_1.EmailPreference)),
    __metadata("design:paramtypes", [typeof (_a = typeof config_1.ConfigService !== "undefined" && config_1.ConfigService) === "function" ? _a : Object, typeof (_b = typeof bull_2.Queue !== "undefined" && bull_2.Queue) === "function" ? _b : Object, typeof (_c = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _c : Object, typeof (_d = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _d : Object, typeof (_e = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _e : Object, typeof (_f = typeof jwt_1.JwtService !== "undefined" && jwt_1.JwtService) === "function" ? _f : Object])
], EmailService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxvam9zZXBoXFxEb2N1bWVudHNcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFxlbWFpbFxcZW1haWwuc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztHQUVHO0FBQ0gsMkNBQXVFO0FBQ3ZFLDZDQUFtRDtBQUNuRCxxQ0FBcUM7QUFDckMsdUNBQTJDO0FBQzNDLCtCQUE2QjtBQUM3QiwyQ0FBK0M7QUFDL0MsdURBQXlDO0FBQ3pDLHVEQUF5QztBQUN6Qyx1Q0FBeUI7QUFDekIsMkNBQTZCO0FBRTdCLDRFQUFpRTtBQUNqRSxrRUFBdUQ7QUFDdkQsZ0ZBQXFFO0FBQ3JFLHlEQUE0RTtBQUM1RSxxQ0FBeUM7QUFhekMsSUFBSyxTQUtKO0FBTEQsV0FBSyxTQUFTO0lBQ1osZ0RBQW1DLENBQUE7SUFDbkMsNkNBQWdDLENBQUE7SUFDaEMsNkNBQWdDLENBQUE7SUFDaEMseUNBQTRCLENBQUE7QUFDOUIsQ0FBQyxFQUxJLFNBQVMsS0FBVCxTQUFTLFFBS2I7QUFHTSxJQUFNLFlBQVksb0JBQWxCLE1BQU0sWUFBWTtJQUl2QixZQUNVLGFBQTRCLEVBQ2QsVUFBeUIsRUFFL0MsdUJBQTBELEVBRTFELGtCQUFnRCxFQUVoRCx5QkFBOEQsRUFDN0MsVUFBdUI7UUFSaEMsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDTixlQUFVLEdBQVYsVUFBVSxDQUFPO1FBRXZDLDRCQUF1QixHQUF2Qix1QkFBdUIsQ0FBMkI7UUFFbEQsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFzQjtRQUV4Qyw4QkFBeUIsR0FBekIseUJBQXlCLENBQTZCO1FBQzdDLGVBQVUsR0FBVixVQUFVLENBQWE7UUFaekIsV0FBTSxHQUFHLElBQUksZUFBTSxDQUFDLGNBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQWN0RCxJQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQztJQUMvQixDQUFDO0lBRUQ7O09BRUc7SUFDSyxx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QkFBVSxvREFFZixvQkFBVSxvQkFBVixvQkFBVSxvREFFSCxvQkFBVSxvQkFBVixvQkFBVSxvREFDZixnQkFBVSxvQkFBVixnQkFBVTtHQWIvQixZQUFZLENBcWN4QiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXG9qb3NlcGhcXERvY3VtZW50c1xcU3RyZWxsZXJNaW5kcy1CYWNrZW5kXFxzcmNcXGVtYWlsXFxlbWFpbC5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBFbWFpbFNlcnZpY2UgcHJvdmlkZXMgbG9naWMgZm9yIHNlbmRpbmcgZW1haWxzLCBtYW5hZ2luZyBwcmVmZXJlbmNlcywgYW5hbHl0aWNzLCBhbmQgdHJhY2tpbmcuXHJcbiAqL1xyXG5pbXBvcnQgeyBJbmplY3RhYmxlLCBMb2dnZXIsIE5vdEZvdW5kRXhjZXB0aW9uIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xyXG5pbXBvcnQgeyBJbmplY3RSZXBvc2l0b3J5IH0gZnJvbSAnQG5lc3Rqcy90eXBlb3JtJztcclxuaW1wb3J0IHsgUmVwb3NpdG9yeSB9IGZyb20gJ3R5cGVvcm0nO1xyXG5pbXBvcnQgeyBJbmplY3RRdWV1ZSB9IGZyb20gJ0BuZXN0anMvYnVsbCc7XHJcbmltcG9ydCB7IFF1ZXVlIH0gZnJvbSAnYnVsbCc7XHJcbmltcG9ydCB7IENvbmZpZ1NlcnZpY2UgfSBmcm9tICdAbmVzdGpzL2NvbmZpZyc7XHJcbmltcG9ydCAqIGFzIG5vZGVtYWlsZXIgZnJvbSAnbm9kZW1haWxlcic7XHJcbmltcG9ydCAqIGFzIEhhbmRsZWJhcnMgZnJvbSAnaGFuZGxlYmFycyc7XHJcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcclxuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcclxuaW1wb3J0ICogYXMgY3J5cHRvIGZyb20gJ2NyeXB0byc7XHJcbmltcG9ydCB7IEVtYWlsVGVtcGxhdGUgfSBmcm9tICcuL2VudGl0aWVzL2VtYWlsLXRlbXBsYXRlLmVudGl0eSc7XHJcbmltcG9ydCB7IEVtYWlsTG9nIH0gZnJvbSAnLi9lbnRpdGllcy9lbWFpbC1sb2cuZW50aXR5JztcclxuaW1wb3J0IHsgRW1haWxQcmVmZXJlbmNlIH0gZnJvbSAnLi9lbnRpdGllcy9lbWFpbC1wcmVmZXJlbmNlLmVudGl0eSc7XHJcbmltcG9ydCB7IGFkZFRyYWNraW5nVG9FbWFpbCwgZ2VuZXJhdGVFbWFpbElkIH0gZnJvbSAnLi91dGlscy90cmFja2luZy51dGlsJztcclxuaW1wb3J0IHsgSnd0U2VydmljZSB9IGZyb20gJ0BuZXN0anMvand0JztcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgRW1haWxPcHRpb25zIHtcclxuICB0bzogc3RyaW5nIHwgc3RyaW5nW107XHJcbiAgc3ViamVjdDogc3RyaW5nO1xyXG4gIHRlbXBsYXRlTmFtZTogc3RyaW5nO1xyXG4gIGNvbnRleHQ6IFJlY29yZDxzdHJpbmcsIGFueT47XHJcbiAgYXR0YWNobWVudHM/OiBhbnlbXTtcclxuICBjYz86IHN0cmluZyB8IHN0cmluZ1tdO1xyXG4gIGJjYz86IHN0cmluZyB8IHN0cmluZ1tdO1xyXG4gIHNraXBUcmFja2luZz86IGJvb2xlYW47XHJcbn1cclxuXHJcbmVudW0gRW1haWxUeXBlIHtcclxuICBWRVJJRklDQVRJT04gPSAnZW1haWwtdmVyaWZpY2F0aW9uJyxcclxuICBFTlJPTExNRU5UID0gJ2NvdXJzZS1lbnJvbGxtZW50JyxcclxuICBDT01QTEVUSU9OID0gJ2NvdXJzZS1jb21wbGV0aW9uJyxcclxuICBGT1JVTSA9ICdmb3J1bS1ub3RpZmljYXRpb24nLFxyXG59XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBFbWFpbFNlcnZpY2Uge1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyID0gbmV3IExvZ2dlcihFbWFpbFNlcnZpY2UubmFtZSk7XHJcbiAgcHJpdmF0ZSB0cmFuc3BvcnRlcjogbm9kZW1haWxlci5UcmFuc3BvcnRlcjtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGNvbmZpZ1NlcnZpY2U6IENvbmZpZ1NlcnZpY2UsXHJcbiAgICBASW5qZWN0UXVldWUoJ2VtYWlsJykgcHJpdmF0ZSBlbWFpbFF1ZXVlOiBRdWV1ZSxcclxuICAgIEBJbmplY3RSZXBvc2l0b3J5KEVtYWlsVGVtcGxhdGUpXHJcbiAgICBwcml2YXRlIGVtYWlsVGVtcGxhdGVSZXBvc2l0b3J5OiBSZXBvc2l0b3J5PEVtYWlsVGVtcGxhdGU+LFxyXG4gICAgQEluamVjdFJlcG9zaXRvcnkoRW1haWxMb2cpXHJcbiAgICBwcml2YXRlIGVtYWlsTG9nUmVwb3NpdG9yeTogUmVwb3NpdG9yeTxFbWFpbExvZz4sXHJcbiAgICBASW5qZWN0UmVwb3NpdG9yeShFbWFpbFByZWZlcmVuY2UpXHJcbiAgICBwcml2YXRlIGVtYWlsUHJlZmVyZW5jZVJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8RW1haWxQcmVmZXJlbmNlPixcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgand0U2VydmljZT86IEp3dFNlcnZpY2UsXHJcbiAgKSB7XHJcbiAgICB0aGlzLmluaXRpYWxpemVUcmFuc3BvcnRlcigpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogSW5pdGlhbGl6ZSB0aGUgbm9kZW1haWxlciB0cmFuc3BvcnRlciB1c2luZyBjb25maWcgdmFsdWVzLlxyXG4gICAqL1xyXG4gIHByaXZhdGUgaW5pdGlhbGl6ZVRyYW5zcG9ydGVyKCkge1xyXG4gICAgdGhpcy50cmFuc3BvcnRlciA9IG5vZGVtYWlsZXIuY3JlYXRlVHJhbnNwb3J0KHtcclxuICAgICAgaG9zdDogdGhpcy5jb25maWdTZXJ2aWNlLmdldDxzdHJpbmc+KCdFTUFJTF9IT1NUJyksXHJcbiAgICAgIHBvcnQ6IHRoaXMuY29uZmlnU2VydmljZS5nZXQ8bnVtYmVyPignRU1BSUxfUE9SVCcpLFxyXG4gICAgICBzZWN1cmU6IHRoaXMuY29uZmlnU2VydmljZS5nZXQ8Ym9vbGVhbj4oJ0VNQUlMX1NFQ1VSRScsIGZhbHNlKSxcclxuICAgICAgYXV0aDoge1xyXG4gICAgICAgIHVzZXI6IHRoaXMuY29uZmlnU2VydmljZS5nZXQ8c3RyaW5nPignRU1BSUxfVVNFUicpLFxyXG4gICAgICAgIHBhc3M6IHRoaXMuY29uZmlnU2VydmljZS5nZXQ8c3RyaW5nPignRU1BSUxfUEFTU1dPUkQnKSxcclxuICAgICAgfSxcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2VuZCBhbiBlbWFpbCB1c2luZyB0aGUgc3BlY2lmaWVkIG9wdGlvbnMuIFF1ZXVlcyB0aGUgZW1haWwgZm9yIHNlbmRpbmcuXHJcbiAgICogQHBhcmFtIG9wdGlvbnMgLSBFbWFpbCBvcHRpb25zXHJcbiAgICogQHJldHVybnMgVHJ1ZSBpZiB0aGUgZW1haWwgd2FzIHN1Y2Nlc3NmdWxseSBxdWV1ZWQsIGZhbHNlIG90aGVyd2lzZVxyXG4gICAqL1xyXG4gIGFzeW5jIHNlbmRFbWFpbChvcHRpb25zOiBFbWFpbE9wdGlvbnMpOiBQcm9taXNlPGJvb2xlYW4+IHtcclxuICAgIGNvbnN0IGVtYWlsRW5hYmxlZCA9IHRoaXMuY29uZmlnU2VydmljZS5nZXQ8c3RyaW5nPignRU1BSUxfRU5BQkxFRCcpO1xyXG4gICAgaWYgKGVtYWlsRW5hYmxlZCA9PT0gJ2ZhbHNlJyB8fCBlbWFpbEVuYWJsZWQgPT09ICcwJykge1xyXG4gICAgICB0aGlzLmxvZ2dlci5sb2coJ0VtYWlsIHNlbmRpbmcgaXMgZGlzYWJsZWQgYnkgRU1BSUxfRU5BQkxFRCBmbGFnLiBTa2lwcGluZyBlbWFpbC4nKTtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gICAgdHJ5IHtcclxuICAgICAgaWYgKGF3YWl0IHRoaXMuaGFzVXNlck9wdGVkT3V0KG9wdGlvbnMudG8sIG9wdGlvbnMudGVtcGxhdGVOYW1lKSkge1xyXG4gICAgICAgIHRoaXMubG9nZ2VyLmxvZyhgVXNlciAke29wdGlvbnMudG99IGhhcyBvcHRlZCBvdXQgb2YgJHtvcHRpb25zLnRlbXBsYXRlTmFtZX0gZW1haWxzYCk7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICB9XHJcbiAgICAgIGF3YWl0IHRoaXMuZW1haWxRdWV1ZS5hZGQoJ3NlbmQnLCBvcHRpb25zLCB7XHJcbiAgICAgICAgYXR0ZW1wdHM6IDMsXHJcbiAgICAgICAgYmFja29mZjoge1xyXG4gICAgICAgICAgdHlwZTogJ2V4cG9uZW50aWFsJyxcclxuICAgICAgICAgIGRlbGF5OiA1MDAwLFxyXG4gICAgICAgIH0sXHJcbiAgICAgIH0pO1xyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGBGYWlsZWQgdG8gcXVldWUgZW1haWw6ICR7ZXJyb3IubWVzc2FnZX1gLCBlcnJvci5zdGFjayk7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNlbmQgYW4gZW1haWwgaW1tZWRpYXRlbHkgdXNpbmcgdGhlIHNwZWNpZmllZCBvcHRpb25zLiBCeXBhc3NlcyB0aGUgcXVldWUuXHJcbiAgICogQHBhcmFtIG9wdGlvbnMgLSBFbWFpbCBvcHRpb25zXHJcbiAgICogQHJldHVybnMgVHJ1ZSBpZiB0aGUgZW1haWwgd2FzIHN1Y2Nlc3NmdWxseSBzZW50LCBmYWxzZSBvdGhlcndpc2VcclxuICAgKi9cclxuICBhc3luYyBzZW5kSW1tZWRpYXRlKG9wdGlvbnM6IEVtYWlsT3B0aW9ucyk6IFByb21pc2U8Ym9vbGVhbj4ge1xyXG4gICAgY29uc3QgZW1haWxFbmFibGVkID0gdGhpcy5jb25maWdTZXJ2aWNlLmdldDxzdHJpbmc+KCdFTUFJTF9FTkFCTEVEJyk7XHJcbiAgICBpZiAoZW1haWxFbmFibGVkID09PSAnZmFsc2UnIHx8IGVtYWlsRW5hYmxlZCA9PT0gJzAnKSB7XHJcbiAgICAgIHRoaXMubG9nZ2VyLmxvZygnRW1haWwgc2VuZGluZyBpcyBkaXNhYmxlZCBieSBFTUFJTF9FTkFCTEVEIGZsYWcuIFNraXBwaW5nIGltbWVkaWF0ZSBlbWFpbC4nKTtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgdGVtcGxhdGUgPSBhd2FpdCB0aGlzLmdldFRlbXBsYXRlKG9wdGlvbnMudGVtcGxhdGVOYW1lKTtcclxuICAgICAgY29uc3QgY29tcGlsZWRUZW1wbGF0ZSA9IEhhbmRsZWJhcnMuY29tcGlsZSh0ZW1wbGF0ZSk7XHJcbiAgICAgIGxldCBodG1sID0gY29tcGlsZWRUZW1wbGF0ZShvcHRpb25zLmNvbnRleHQpO1xyXG4gICAgICBjb25zdCBlbWFpbElkID0gZ2VuZXJhdGVFbWFpbElkKCk7XHJcblxyXG4gICAgICBpZiAoIW9wdGlvbnMuc2tpcFRyYWNraW5nKSB7XHJcbiAgICAgICAgY29uc3QgYmFzZVVybCA9IHRoaXMuY29uZmlnU2VydmljZS5nZXQ8c3RyaW5nPignQkFTRV9VUkwnKTtcclxuICAgICAgICBodG1sID0gYWRkVHJhY2tpbmdUb0VtYWlsKGh0bWwsIGVtYWlsSWQsIGJhc2VVcmwpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zdCBtYWlsT3B0aW9ucyA9IHtcclxuICAgICAgICBmcm9tOiB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oJ0VNQUlMX0ZST00nKSxcclxuICAgICAgICB0bzogb3B0aW9ucy50byxcclxuICAgICAgICBjYzogb3B0aW9ucy5jYyxcclxuICAgICAgICBiY2M6IG9wdGlvbnMuYmNjLFxyXG4gICAgICAgIHN1YmplY3Q6IG9wdGlvbnMuc3ViamVjdCxcclxuICAgICAgICBodG1sLFxyXG4gICAgICAgIGF0dGFjaG1lbnRzOiBvcHRpb25zLmF0dGFjaG1lbnRzIHx8IFtdLFxyXG4gICAgICB9O1xyXG5cclxuICAgICAgY29uc3QgaW5mbyA9IGF3YWl0IHRoaXMudHJhbnNwb3J0ZXIuc2VuZE1haWwobWFpbE9wdGlvbnMpO1xyXG5cclxuICAgICAgYXdhaXQgdGhpcy5sb2dFbWFpbCh7XHJcbiAgICAgICAgaWQ6IGVtYWlsSWQsXHJcbiAgICAgICAgcmVjaXBpZW50OiBBcnJheS5pc0FycmF5KG9wdGlvbnMudG8pID8gb3B0aW9ucy50by5qb2luKCcsICcpIDogb3B0aW9ucy50byxcclxuICAgICAgICBzdWJqZWN0OiBvcHRpb25zLnN1YmplY3QsXHJcbiAgICAgICAgdGVtcGxhdGVOYW1lOiBvcHRpb25zLnRlbXBsYXRlTmFtZSxcclxuICAgICAgICBtZXNzYWdlSWQ6IGluZm8ubWVzc2FnZUlkLFxyXG4gICAgICAgIHN0YXR1czogJ3NlbnQnLFxyXG4gICAgICAgIC8vIHRyYWNraW5nXHJcbiAgICAgICAgdHJhY2tpbmdFbmFibGVkOiAhb3B0aW9ucy5za2lwVHJhY2tpbmcsXHJcbiAgICAgICAgdHJhY2tpbmdUb2tlbjogIW9wdGlvbnMuc2tpcFRyYWNraW5nID8gZW1haWxJZCA6IG51bGwsXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihgRmFpbGVkIHRvIHNlbmQgZW1haWw6ICR7ZXJyb3IubWVzc2FnZX1gLCBlcnJvci5zdGFjayk7XHJcbiAgICAgIGF3YWl0IHRoaXMubG9nRW1haWwoe1xyXG4gICAgICAgIHJlY2lwaWVudDogQXJyYXkuaXNBcnJheShvcHRpb25zLnRvKSA/IG9wdGlvbnMudG8uam9pbignLCAnKSA6IG9wdGlvbnMudG8sXHJcbiAgICAgICAgc3ViamVjdDogb3B0aW9ucy5zdWJqZWN0LFxyXG4gICAgICAgIHRlbXBsYXRlTmFtZTogb3B0aW9ucy50ZW1wbGF0ZU5hbWUsXHJcbiAgICAgICAgc3RhdHVzOiAnZmFpbGVkJyxcclxuICAgICAgICBlcnJvcjogZXJyb3IubWVzc2FnZSxcclxuICAgICAgfSk7XHJcblxyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBHZXQgdGhlIGVtYWlsIHRlbXBsYXRlIGNvbnRlbnQgYnkgbmFtZS4gRmlyc3QgY2hlY2tzIHRoZSBkYXRhYmFzZSwgdGhlbiBmYWxscyBiYWNrIHRvIGZpbGUgc3lzdGVtLlxyXG4gICAqIEBwYXJhbSB0ZW1wbGF0ZU5hbWUgLSBOYW1lIG9mIHRoZSB0ZW1wbGF0ZVxyXG4gICAqIEByZXR1cm5zIFRoZSB0ZW1wbGF0ZSBjb250ZW50XHJcbiAgICovXHJcbiAgYXN5bmMgZ2V0VGVtcGxhdGUodGVtcGxhdGVOYW1lOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xyXG4gICAgY29uc3QgZGJUZW1wbGF0ZSA9IGF3YWl0IHRoaXMuZW1haWxUZW1wbGF0ZVJlcG9zaXRvcnkuZmluZE9uZSh7IHdoZXJlOiB7IG5hbWU6IHRlbXBsYXRlTmFtZSB9IH0pO1xyXG4gICAgaWYgKGRiVGVtcGxhdGUpIHJldHVybiBkYlRlbXBsYXRlLmNvbnRlbnQ7XHJcblxyXG4gICAgY29uc3QgdGVtcGxhdGVQYXRoID0gcGF0aC5qb2luKHByb2Nlc3MuY3dkKCksICdzcmMvZW1haWwvdGVtcGxhdGVzJywgYCR7dGVtcGxhdGVOYW1lfS5oYnNgKTtcclxuICAgIHJldHVybiBmcy5yZWFkRmlsZVN5bmModGVtcGxhdGVQYXRoLCAndXRmOCcpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogTG9nIGFuIGVtYWlsIGV2ZW50IHRvIHRoZSBkYXRhYmFzZS5cclxuICAgKiBAcGFyYW0gbG9nRGF0YSAtIFBhcnRpYWwgZW1haWwgbG9nIGRhdGFcclxuICAgKi9cclxuICBwcml2YXRlIGFzeW5jIGxvZ0VtYWlsKGxvZ0RhdGE6IFBhcnRpYWw8RW1haWxMb2c+KTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBjb25zdCBsb2cgPSB0aGlzLmVtYWlsTG9nUmVwb3NpdG9yeS5jcmVhdGUobG9nRGF0YSk7XHJcbiAgICBhd2FpdCB0aGlzLmVtYWlsTG9nUmVwb3NpdG9yeS5zYXZlKGxvZyk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDaGVjayBpZiBhIHVzZXIgaGFzIG9wdGVkIG91dCBvZiBhIHNwZWNpZmljIGVtYWlsIHR5cGUuXHJcbiAgICogQHBhcmFtIHJlY2lwaWVudCAtIFJlY2lwaWVudCBlbWFpbCBhZGRyZXNzXHJcbiAgICogQHBhcmFtIHRlbXBsYXRlVHlwZSAtIEVtYWlsIHRlbXBsYXRlIHR5cGVcclxuICAgKiBAcmV0dXJucyBUcnVlIGlmIHRoZSB1c2VyIGhhcyBvcHRlZCBvdXQsIGZhbHNlIG90aGVyd2lzZVxyXG4gICAqL1xyXG4gIHByaXZhdGUgYXN5bmMgaGFzVXNlck9wdGVkT3V0KFxyXG4gICAgcmVjaXBpZW50OiBzdHJpbmcgfCBzdHJpbmdbXSxcclxuICAgIHRlbXBsYXRlVHlwZTogc3RyaW5nLFxyXG4gICk6IFByb21pc2U8Ym9vbGVhbj4ge1xyXG4gICAgaWYgKEFycmF5LmlzQXJyYXkocmVjaXBpZW50KSkge1xyXG4gICAgICBmb3IgKGNvbnN0IGVtYWlsIG9mIHJlY2lwaWVudCkge1xyXG4gICAgICAgIGNvbnN0IHByZWZlcmVuY2UgPSBhd2FpdCB0aGlzLmVtYWlsUHJlZmVyZW5jZVJlcG9zaXRvcnkuZmluZE9uZSh7IHdoZXJlOiB7IGVtYWlsLCBvcHRPdXQ6IHRydWUgfSB9KTtcclxuICAgICAgICBpZiAocHJlZmVyZW5jZSkgcmV0dXJuIHRydWU7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHByZWZlcmVuY2UgPSBhd2FpdCB0aGlzLmVtYWlsUHJlZmVyZW5jZVJlcG9zaXRvcnkuZmluZE9uZSh7IHdoZXJlOiB7IGVtYWlsOiByZWNpcGllbnQsIG9wdE91dDogdHJ1ZSB9IH0pO1xyXG4gICAgcmV0dXJuICEhcHJlZmVyZW5jZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFVwZGF0ZSBhIHVzZXIncyBlbWFpbCBwcmVmZXJlbmNlIGZvciBhIHNwZWNpZmljIGVtYWlsIHR5cGUuXHJcbiAgICogQHBhcmFtIGVtYWlsIC0gVXNlciBlbWFpbCBhZGRyZXNzXHJcbiAgICogQHBhcmFtIGVtYWlsVHlwZSAtIFR5cGUgb2YgZW1haWxcclxuICAgKiBAcGFyYW0gb3B0T3V0IC0gV2hldGhlciB0aGUgdXNlciBvcHRzIG91dFxyXG4gICAqIEByZXR1cm5zIFRoZSB1cGRhdGVkIEVtYWlsUHJlZmVyZW5jZSBlbnRpdHlcclxuICAgKi9cclxuICBhc3luYyB1cGRhdGVFbWFpbFByZWZlcmVuY2UoZW1haWw6IHN0cmluZywgZW1haWxUeXBlOiBzdHJpbmcsIG9wdE91dDogYm9vbGVhbik6IFByb21pc2U8RW1haWxQcmVmZXJlbmNlPiB7XHJcbiAgICBsZXQgcHJlZmVyZW5jZSA9IGF3YWl0IHRoaXMuZW1haWxQcmVmZXJlbmNlUmVwb3NpdG9yeS5maW5kT25lKHsgd2hlcmU6IHsgZW1haWwgfSB9KTtcclxuXHJcbiAgICBpZiAocHJlZmVyZW5jZSkge1xyXG4gICAgICBwcmVmZXJlbmNlLm9wdE91dCA9IG9wdE91dDtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHByZWZlcmVuY2UgPSB0aGlzLmVtYWlsUHJlZmVyZW5jZVJlcG9zaXRvcnkuY3JlYXRlKHsgZW1haWwsIG9wdE91dCB9KTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdGhpcy5lbWFpbFByZWZlcmVuY2VSZXBvc2l0b3J5LnNhdmUocHJlZmVyZW5jZSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBHZXQgZW1haWwgYW5hbHl0aWNzIGZvciBhIGRhdGUgcmFuZ2UgYW5kIG9wdGlvbmFsIHRlbXBsYXRlIG5hbWUuXHJcbiAgICogQHBhcmFtIHN0YXJ0RGF0ZSAtIFN0YXJ0IGRhdGVcclxuICAgKiBAcGFyYW0gZW5kRGF0ZSAtIEVuZCBkYXRlXHJcbiAgICogQHBhcmFtIHRlbXBsYXRlTmFtZSAtIE9wdGlvbmFsIHRlbXBsYXRlIG5hbWVcclxuICAgKiBAcmV0dXJucyBBbmFseXRpY3MgZGF0YVxyXG4gICAqL1xyXG4gIGFzeW5jIGdldEVtYWlsQW5hbHl0aWNzKHN0YXJ0RGF0ZTogRGF0ZSwgZW5kRGF0ZTogRGF0ZSwgdGVtcGxhdGVOYW1lPzogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcclxuICAgIGNvbnN0IHF1ZXJ5ID0gdGhpcy5lbWFpbExvZ1JlcG9zaXRvcnlcclxuICAgICAgLmNyZWF0ZVF1ZXJ5QnVpbGRlcignbG9nJylcclxuICAgICAgLnNlbGVjdCgnbG9nLnRlbXBsYXRlTmFtZScsICd0ZW1wbGF0ZU5hbWUnKVxyXG4gICAgICAuYWRkU2VsZWN0KCdDT1VOVCgqKScsICdjb3VudCcpXHJcbiAgICAgIC5hZGRTZWxlY3QoJ2xvZy5zdGF0dXMnLCAnc3RhdHVzJylcclxuICAgICAgLndoZXJlKCdsb2cuY3JlYXRlZEF0IEJFVFdFRU4gOnN0YXJ0RGF0ZSBBTkQgOmVuZERhdGUnLCB7IHN0YXJ0RGF0ZSwgZW5kRGF0ZSB9KVxyXG4gICAgICAuZ3JvdXBCeSgnbG9nLnRlbXBsYXRlTmFtZScpXHJcbiAgICAgIC5hZGRHcm91cEJ5KCdsb2cuc3RhdHVzJyk7XHJcblxyXG4gICAgaWYgKHRlbXBsYXRlTmFtZSkge1xyXG4gICAgICBxdWVyeS5hbmRXaGVyZSgnbG9nLnRlbXBsYXRlTmFtZSA9IDp0ZW1wbGF0ZU5hbWUnLCB7IHRlbXBsYXRlTmFtZSB9KTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcXVlcnkuZ2V0UmF3TWFueSgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2VuZCBhIHZlcmlmaWNhdGlvbiBlbWFpbCB0byB0aGUgdXNlci5cclxuICAgKiBAcGFyYW0gdXNlciAtIFVzZXIgb2JqZWN0XHJcbiAgICogQHBhcmFtIHZlcmlmaWNhdGlvbkNvZGUgLSBWZXJpZmljYXRpb24gY29kZVxyXG4gICAqIEBwYXJhbSB2ZXJpZmljYXRpb25Ub2tlbiAtIFZlcmlmaWNhdGlvbiB0b2tlblxyXG4gICAqIEByZXR1cm5zIFRydWUgaWYgdGhlIGVtYWlsIHdhcyBzdWNjZXNzZnVsbHkgc2VudCwgZmFsc2Ugb3RoZXJ3aXNlXHJcbiAgICovXHJcbiAgYXN5bmMgc2VuZFZlcmlmaWNhdGlvbkVtYWlsKHVzZXI6IGFueSwgdmVyaWZpY2F0aW9uQ29kZTogc3RyaW5nLCB2ZXJpZmljYXRpb25Ub2tlbjogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XHJcbiAgICBjb25zdCB2ZXJpZmljYXRpb25VcmwgPSBgJHt0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oJ0ZST05URU5EX1VSTCcpfS92ZXJpZnktZW1haWw/dG9rZW49JHt2ZXJpZmljYXRpb25Ub2tlbn1gO1xyXG4gICAgY29uc3QgdW5zdWJzY3JpYmVVcmwgPSBgJHt0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oJ0ZST05URU5EX1VSTCcpfS9wcmVmZXJlbmNlcz9lbWFpbD0ke3VzZXIuZW1haWx9YDtcclxuXHJcbiAgICByZXR1cm4gdGhpcy5zZW5kRW1haWwoe1xyXG4gICAgICB0bzogdXNlci5lbWFpbCxcclxuICAgICAgc3ViamVjdDogJ1ZlcmlmeSBZb3VyIEVtYWlsIEFkZHJlc3MnLFxyXG4gICAgICB0ZW1wbGF0ZU5hbWU6ICdlbWFpbC12ZXJpZmljYXRpb24nLFxyXG4gICAgICBjb250ZXh0OiB7XHJcbiAgICAgICAgbmFtZTogdXNlci5uYW1lLFxyXG4gICAgICAgIHZlcmlmaWNhdGlvblVybCxcclxuICAgICAgICB2ZXJpZmljYXRpb25Db2RlLFxyXG4gICAgICAgIGV4cGlyeVRpbWU6IDI0LFxyXG4gICAgICAgIHVuc3Vic2NyaWJlVXJsLFxyXG4gICAgICAgIHllYXI6IG5ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKSxcclxuICAgICAgfSxcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2VuZCBhIGNvdXJzZSBlbnJvbGxtZW50IGVtYWlsIHRvIHRoZSB1c2VyLlxyXG4gICAqIEBwYXJhbSB1c2VyIC0gVXNlciBvYmplY3RcclxuICAgKiBAcGFyYW0gY291cnNlIC0gQ291cnNlIG9iamVjdFxyXG4gICAqIEByZXR1cm5zIFRydWUgaWYgdGhlIGVtYWlsIHdhcyBzdWNjZXNzZnVsbHkgc2VudCwgZmFsc2Ugb3RoZXJ3aXNlXHJcbiAgICovXHJcbiAgYXN5bmMgc2VuZENvdXJzZUVucm9sbG1lbnRFbWFpbCh1c2VyOiBhbnksIGNvdXJzZTogYW55KTogUHJvbWlzZTxib29sZWFuPiB7XHJcbiAgICBjb25zdCBjb3Vyc2VVcmwgPSBgJHt0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oJ0ZST05URU5EX1VSTCcpfS9jb3Vyc2VzLyR7Y291cnNlLmlkfWA7XHJcbiAgICBjb25zdCB1bnN1YnNjcmliZVVybCA9IGAke3RoaXMuY29uZmlnU2VydmljZS5nZXQ8c3RyaW5nPignRlJPTlRFTkRfVVJMJyl9L3ByZWZlcmVuY2VzP2VtYWlsPSR7dXNlci5lbWFpbH1gO1xyXG5cclxuICAgIHJldHVybiB0aGlzLnNlbmRFbWFpbCh7XHJcbiAgICAgIHRvOiB1c2VyLmVtYWlsLFxyXG4gICAgICBzdWJqZWN0OiBgRW5yb2xsbWVudCBDb25maXJtYXRpb246ICR7Y291cnNlLm5hbWV9YCxcclxuICAgICAgdGVtcGxhdGVOYW1lOiAnY291cnNlLWVucm9sbG1lbnQnLFxyXG4gICAgICBjb250ZXh0OiB7XHJcbiAgICAgICAgbmFtZTogdXNlci5uYW1lLFxyXG4gICAgICAgIGNvdXJzZU5hbWU6IGNvdXJzZS5uYW1lLFxyXG4gICAgICAgIGluc3RydWN0b3JOYW1lOiBjb3Vyc2UuaW5zdHJ1Y3Rvci5uYW1lLFxyXG4gICAgICAgIHN0YXJ0RGF0ZTogbmV3IERhdGUoY291cnNlLnN0YXJ0RGF0ZSkudG9Mb2NhbGVEYXRlU3RyaW5nKCksXHJcbiAgICAgICAgZHVyYXRpb246IGNvdXJzZS5kdXJhdGlvbixcclxuICAgICAgICBjb3Vyc2VVcmwsXHJcbiAgICAgICAgdW5zdWJzY3JpYmVVcmwsXHJcbiAgICAgICAgeWVhcjogbmV3IERhdGUoKS5nZXRGdWxsWWVhcigpLFxyXG4gICAgICB9LFxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTZW5kIGEgY291cnNlIGNvbXBsZXRpb24gZW1haWwgdG8gdGhlIHVzZXIuXHJcbiAgICogQHBhcmFtIHVzZXIgLSBVc2VyIG9iamVjdFxyXG4gICAqIEBwYXJhbSBjb3Vyc2UgLSBDb3Vyc2Ugb2JqZWN0XHJcbiAgICogQHBhcmFtIHNjb3JlIC0gQ29tcGxldGlvbiBzY29yZVxyXG4gICAqIEByZXR1cm5zIFRydWUgaWYgdGhlIGVtYWlsIHdhcyBzdWNjZXNzZnVsbHkgc2VudCwgZmFsc2Ugb3RoZXJ3aXNlXHJcbiAgICovXHJcbiAgYXN5bmMgc2VuZENvdXJzZUNvbXBsZXRpb25FbWFpbCh1c2VyOiBhbnksIGNvdXJzZTogYW55LCBzY29yZTogbnVtYmVyKTogUHJvbWlzZTxib29sZWFuPiB7XHJcbiAgICBjb25zdCBjZXJ0aWZpY2F0ZVVybCA9IGAke3RoaXMuY29uZmlnU2VydmljZS5nZXQ8c3RyaW5nPignRlJPTlRFTkRfVVJMJyl9L2NlcnRpZmljYXRlcy8ke2NvdXJzZS5pZH1gO1xyXG4gICAgY29uc3QgY291cnNlQ2F0YWxvZ1VybCA9IGAke3RoaXMuY29uZmlnU2VydmljZS5nZXQ8c3RyaW5nPignRlJPTlRFTkRfVVJMJyl9L2NvdXJzZXNgO1xyXG4gICAgY29uc3QgdW5zdWJzY3JpYmVVcmwgPSBgJHt0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oJ0ZST05URU5EX1VSTCcpfS9wcmVmZXJlbmNlcz9lbWFpbD0ke3VzZXIuZW1haWx9YDtcclxuXHJcbiAgICByZXR1cm4gdGhpcy5zZW5kRW1haWwoe1xyXG4gICAgICB0bzogdXNlci5lbWFpbCxcclxuICAgICAgc3ViamVjdDogYENvbmdyYXR1bGF0aW9ucyBvbiBDb21wbGV0aW5nICR7Y291cnNlLm5hbWV9IWAsXHJcbiAgICAgIHRlbXBsYXRlTmFtZTogJ2NvdXJzZS1jb21wbGV0aW9uJyxcclxuICAgICAgY29udGV4dDoge1xyXG4gICAgICAgIG5hbWU6IHVzZXIubmFtZSxcclxuICAgICAgICBjb3Vyc2VOYW1lOiBjb3Vyc2UubmFtZSxcclxuICAgICAgICBzY29yZSxcclxuICAgICAgICBjb21wbGV0aW9uRGF0ZTogbmV3IERhdGUoKS50b0xvY2FsZURhdGVTdHJpbmcoKSxcclxuICAgICAgICBjZXJ0aWZpY2F0ZVVybCxcclxuICAgICAgICBjb3Vyc2VDYXRhbG9nVXJsLFxyXG4gICAgICAgIHVuc3Vic2NyaWJlVXJsLFxyXG4gICAgICAgIHllYXI6IG5ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKSxcclxuICAgICAgfSxcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2VuZCBhIGZvcnVtIG5vdGlmaWNhdGlvbiBlbWFpbCB0byB0aGUgdXNlci5cclxuICAgKiBAcGFyYW0gdXNlciAtIFVzZXIgb2JqZWN0XHJcbiAgICogQHBhcmFtIG5vdGlmaWNhdGlvbiAtIE5vdGlmaWNhdGlvbiBvYmplY3RcclxuICAgKiBAcmV0dXJucyBUcnVlIGlmIHRoZSBlbWFpbCB3YXMgc3VjY2Vzc2Z1bGx5IHNlbnQsIGZhbHNlIG90aGVyd2lzZVxyXG4gICAqL1xyXG4gIGFzeW5jIHNlbmRGb3J1bU5vdGlmaWNhdGlvbkVtYWlsKHVzZXI6IGFueSwgbm90aWZpY2F0aW9uOiBhbnkpOiBQcm9taXNlPGJvb2xlYW4+IHtcclxuICAgIGNvbnN0IHBvc3RVcmwgPSBgJHt0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oJ0ZST05URU5EX1VSTCcpfS9mb3J1bS9wb3N0cy8ke25vdGlmaWNhdGlvbi5wb3N0SWR9YDtcclxuICAgIGNvbnN0IHVuc3Vic2NyaWJlVXJsID0gYCR7dGhpcy5jb25maWdTZXJ2aWNlLmdldDxzdHJpbmc+KCdGUk9OVEVORF9VUkwnKX0vcHJlZmVyZW5jZXM/ZW1haWw9JHt1c2VyLmVtYWlsfWA7XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuc2VuZEVtYWlsKHtcclxuICAgICAgdG86IHVzZXIuZW1haWwsXHJcbiAgICAgIHN1YmplY3Q6IGBGb3J1bSBOb3RpZmljYXRpb246ICR7bm90aWZpY2F0aW9uLnR5cGV9YCxcclxuICAgICAgdGVtcGxhdGVOYW1lOiAnZm9ydW0tbm90aWZpY2F0aW9uJyxcclxuICAgICAgY29udGV4dDoge1xyXG4gICAgICAgIG5hbWU6IHVzZXIubmFtZSxcclxuICAgICAgICBub3RpZmljYXRpb25UeXBlOiBub3RpZmljYXRpb24udHlwZSxcclxuICAgICAgICBub3RpZmljYXRpb25NZXNzYWdlOiBub3RpZmljYXRpb24ubWVzc2FnZSxcclxuICAgICAgICBwb3N0QXV0aG9yOiBub3RpZmljYXRpb24ucG9zdC5hdXRob3IubmFtZSxcclxuICAgICAgICBwb3N0RGF0ZTogbmV3IERhdGUobm90aWZpY2F0aW9uLnBvc3QuY3JlYXRlZEF0KS50b0xvY2FsZURhdGVTdHJpbmcoKSxcclxuICAgICAgICBwb3N0Q29udGVudDogbm90aWZpY2F0aW9uLnBvc3QuY29udGVudCxcclxuICAgICAgICBwb3N0VXJsLFxyXG4gICAgICAgIHVuc3Vic2NyaWJlVXJsLFxyXG4gICAgICAgIHllYXI6IG5ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKSxcclxuICAgICAgfSxcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogTWFyayBhbiBlbWFpbCBhcyBjbGlja2VkIGJ5IGl0cyBsb2cgSUQuXHJcbiAgICogQHBhcmFtIGlkIC0gRW1haWwgbG9nIElEXHJcbiAgICogQHBhcmFtIHVybCAtIFVSTCB0aGF0IHdhcyBjbGlja2VkXHJcbiAgICovXHJcbiAgYXN5bmMgbWFya0VtYWlsQXNDbGlja2VkKFxyXG4gICAgdHJhY2tpbmdUb2tlbjogc3RyaW5nLFxyXG4gICAgdXJsOiBzdHJpbmcsXHJcbiAgICBtZXRhZGF0YT86IHsgdXNlckFnZW50Pzogc3RyaW5nOyBpcEFkZHJlc3M/OiBzdHJpbmcgfSxcclxuICApOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGNvbnN0IGVtYWlsTG9nID0gYXdhaXQgdGhpcy5lbWFpbExvZ1JlcG9zaXRvcnkuZmluZE9uZSh7IHdoZXJlOiB7IHRyYWNraW5nVG9rZW4gfSB9KTtcclxuICAgIGlmICghZW1haWxMb2cpIHtcclxuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdFbWFpbCB0cmFja2luZyB0b2tlbiBub3QgZm91bmQnKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xyXG4gICAgY29uc3QgZXZlbnRzID0gQXJyYXkuaXNBcnJheShlbWFpbExvZy5jbGlja0V2ZW50cykgPyBlbWFpbExvZy5jbGlja0V2ZW50cy5zbGljZSgpIDogW107XHJcbiAgICBldmVudHMucHVzaCh7XHJcbiAgICAgIGNsaWNrZWRBdDogbm93LnRvSVNPU3RyaW5nKCksXHJcbiAgICAgIHVybCxcclxuICAgICAgdXNlckFnZW50OiBtZXRhZGF0YT8udXNlckFnZW50LFxyXG4gICAgICBpcEFkZHJlc3M6IG1ldGFkYXRhPy5pcEFkZHJlc3MsXHJcbiAgICB9KTtcclxuXHJcbiAgICBjb25zdCB1cGRhdGVzOiBQYXJ0aWFsPEVtYWlsTG9nPiA9IHtcclxuICAgICAgY2xpY2tDb3VudDogKGVtYWlsTG9nLmNsaWNrQ291bnQgfHwgMCkgKyAxLFxyXG4gICAgICBjbGlja0V2ZW50czogZXZlbnRzLFxyXG4gICAgfTtcclxuICAgIGlmICghZW1haWxMb2cuZmlyc3RDbGlja2VkQXQpIHtcclxuICAgICAgdXBkYXRlcy5maXJzdENsaWNrZWRBdCA9IG5vdztcclxuICAgIH1cclxuXHJcbiAgICBhd2FpdCB0aGlzLmVtYWlsTG9nUmVwb3NpdG9yeS51cGRhdGUoeyBpZDogZW1haWxMb2cuaWQgfSwgdXBkYXRlcyk7XHJcbiAgICB0aGlzLmxvZ2dlci5sb2coYEVtYWlsIGxpbmsgY2xpY2tlZDogJHt0cmFja2luZ1Rva2VufSAtPiAke3VybH1gKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIE1hcmsgYW4gZW1haWwgYXMgb3BlbmVkIGJ5IGl0cyBsb2cgSUQuXHJcbiAgICogQHBhcmFtIGlkIC0gRW1haWwgbG9nIElEXHJcbiAgICovXHJcbiAgYXN5bmMgbWFya0VtYWlsQXNPcGVuZWQoXHJcbiAgICB0cmFja2luZ1Rva2VuOiBzdHJpbmcsXHJcbiAgICBtZXRhZGF0YT86IHsgdXNlckFnZW50Pzogc3RyaW5nOyBpcEFkZHJlc3M/OiBzdHJpbmcgfSxcclxuICApOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGNvbnN0IGVtYWlsTG9nID0gYXdhaXQgdGhpcy5lbWFpbExvZ1JlcG9zaXRvcnkuZmluZE9uZSh7IHdoZXJlOiB7IHRyYWNraW5nVG9rZW4gfSB9KTtcclxuICAgIGlmICghZW1haWxMb2cpIHtcclxuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdFbWFpbCB0cmFja2luZyB0b2tlbiBub3QgZm91bmQnKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xyXG4gICAgY29uc3QgdXBkYXRlczogUGFydGlhbDxFbWFpbExvZz4gPSB7XHJcbiAgICAgIG9wZW5lZEF0OiBub3csXHJcbiAgICAgIG9wZW5Db3VudDogKGVtYWlsTG9nLm9wZW5Db3VudCB8fCAwKSArIDEsXHJcbiAgICB9O1xyXG4gICAgaWYgKCFlbWFpbExvZy5maXJzdE9wZW5lZEF0KSB7XHJcbiAgICAgIHVwZGF0ZXMuZmlyc3RPcGVuZWRBdCA9IG5vdztcclxuICAgIH1cclxuXHJcbiAgICBhd2FpdCB0aGlzLmVtYWlsTG9nUmVwb3NpdG9yeS51cGRhdGUoeyBpZDogZW1haWxMb2cuaWQgfSwgdXBkYXRlcyk7XHJcbiAgICB0aGlzLmxvZ2dlci5sb2coYEVtYWlsIG9wZW5lZDogJHt0cmFja2luZ1Rva2VufWApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogR2V0IGFuYWx5dGljcyBmb3IgYSBzcGVjaWZpYyBlbWFpbCBsb2dcclxuICAgKi9cclxuICBhc3luYyBnZXRFbWFpbEFuYWx5dGljcyhlbWFpbElkOiBzdHJpbmcpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgY29uc3QgZW1haWxMb2cgPSBhd2FpdCB0aGlzLmVtYWlsTG9nUmVwb3NpdG9yeS5maW5kT25lKHsgd2hlcmU6IHsgaWQ6IGVtYWlsSWQgfSB9KTtcclxuICAgIGlmICghZW1haWxMb2cpIHtcclxuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdFbWFpbCBub3QgZm91bmQnKTtcclxuICAgIH1cclxuICAgIHJldHVybiB7XHJcbiAgICAgIGlkOiBlbWFpbExvZy5pZCxcclxuICAgICAgdG86IGVtYWlsTG9nLnJlY2lwaWVudCxcclxuICAgICAgc3ViamVjdDogZW1haWxMb2cuc3ViamVjdCxcclxuICAgICAgc2VudEF0OiBlbWFpbExvZy5jcmVhdGVkQXQsXHJcbiAgICAgIG9wZW5lZDogISFlbWFpbExvZy5maXJzdE9wZW5lZEF0LFxyXG4gICAgICBvcGVuZWRBdDogZW1haWxMb2cuZmlyc3RPcGVuZWRBdCxcclxuICAgICAgb3BlbkNvdW50OiBlbWFpbExvZy5vcGVuQ291bnQgfHwgMCxcclxuICAgICAgY2xpY2tlZDogISFlbWFpbExvZy5maXJzdENsaWNrZWRBdCxcclxuICAgICAgZmlyc3RDbGlja2VkQXQ6IGVtYWlsTG9nLmZpcnN0Q2xpY2tlZEF0LFxyXG4gICAgICBjbGlja0NvdW50OiBlbWFpbExvZy5jbGlja0NvdW50IHx8IDAsXHJcbiAgICAgIGNsaWNrczogZW1haWxMb2cuY2xpY2tFdmVudHMgfHwgW10sXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogVmVyaWZ5IHRoZSB1bnN1YnNjcmliZSB0b2tlbiBmb3IgYSBnaXZlbiBlbWFpbC5cclxuICAgKiBAcGFyYW0gZW1haWwgLSBVc2VyIGVtYWlsIGFkZHJlc3NcclxuICAgKiBAcGFyYW0gdG9rZW4gLSBVbnN1YnNjcmliZSB0b2tlblxyXG4gICAqIEByZXR1cm5zIFRydWUgaWYgdGhlIHRva2VuIGlzIHZhbGlkLCBmYWxzZSBvdGhlcndpc2VcclxuICAgKi9cclxuICAgYXN5bmMgdmVyaWZ5VW5zdWJzY3JpYmVUb2tlbihlbWFpbDogc3RyaW5nLCB0b2tlbjogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCBzZWNyZXQgPSB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oJ1VOU1VCU0NSSUJFX0pXVF9TRUNSRVQnKSB8fCB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oJ0pXVF9TRUNSRVQnKTtcclxuICAgICAgY29uc3QgcGF5bG9hZCA9ICh0aGlzLmp3dFNlcnZpY2VcclxuICAgICAgICA/IHRoaXMuand0U2VydmljZS52ZXJpZnkodG9rZW4sIHsgc2VjcmV0IH0pXHJcbiAgICAgICAgOiAoYXdhaXQgaW1wb3J0KCdqc29ud2VidG9rZW4nKSkudmVyaWZ5KHRva2VuLCBzZWNyZXQpKSBhcyBhbnk7XHJcbiAgICAgIHJldHVybiAhIXBheWxvYWQgJiYgKHBheWxvYWQuZW1haWwgPT09IGVtYWlsIHx8IHBheWxvYWQuc3ViID09PSBlbWFpbCk7XHJcbiAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgdGhpcy5sb2dnZXIud2FybihgSW52YWxpZCB1bnN1YnNjcmliZSB0b2tlbiBmb3IgJHtlbWFpbH06ICR7ZXJyPy5tZXNzYWdlfWApO1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBHZXQgZGFpbHkgZW1haWwgc3RhdGlzdGljcyBmb3IgYSBkYXRlIHJhbmdlIGFuZCBvcHRpb25hbCB0ZW1wbGF0ZSBuYW1lLlxyXG4gICAqIEBwYXJhbSBzdGFydCAtIFN0YXJ0IGRhdGVcclxuICAgKiBAcGFyYW0gZW5kIC0gRW5kIGRhdGVcclxuICAgKiBAcGFyYW0gdGVtcGxhdGVOYW1lIC0gT3B0aW9uYWwgdGVtcGxhdGUgbmFtZVxyXG4gICAqIEByZXR1cm5zIERhaWx5IGVtYWlsIHN0YXRpc3RpY3NcclxuICAgKi9cclxuICAgYXN5bmMgZ2V0RGFpbHlFbWFpbFN0YXRzKHN0YXJ0OiBEYXRlLCBlbmQ6IERhdGUsIHRlbXBsYXRlTmFtZT86IHN0cmluZyk6IFByb21pc2U8YW55PiB7XHJcbiAgICAvLyBJbXBsZW1lbnQgeW91ciBsb2dpYyBoZXJlIG9yIHJldHVybiBhIG1vY2sgZm9yIG5vd1xyXG4gICAgcmV0dXJuIFtdO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogR2V0IHRoZSB1c2VyJ3MgZW1haWwgcHJlZmVyZW5jZXMgZm9yIGFsbCBlbWFpbCB0eXBlcy5cclxuICAgKiBAcGFyYW0gZW1haWwgLSBVc2VyIGVtYWlsIGFkZHJlc3NcclxuICAgKiBAcmV0dXJucyBBcnJheSBvZiBlbWFpbCBwcmVmZXJlbmNlc1xyXG4gICAqL1xyXG4gICBhc3luYyBnZXRVc2VyUHJlZmVyZW5jZXMoZW1haWw6IHN0cmluZyk6IFByb21pc2U8eyBlbWFpbFR5cGU6IEVtYWlsVHlwZTsgb3B0ZWRPdXQ6IGJvb2xlYW4gfVtdPiB7XHJcbiAgICBjb25zdCBwcmVmZXJlbmNlcyA9IGF3YWl0IHRoaXMuZW1haWxQcmVmZXJlbmNlUmVwb3NpdG9yeS5maW5kKHsgd2hlcmU6IHsgZW1haWwgfSB9KTtcclxuXHJcbiAgICByZXR1cm4gT2JqZWN0LnZhbHVlcyhFbWFpbFR5cGUpLm1hcCgodHlwZSkgPT4ge1xyXG4gICAgICBjb25zdCBwcmVmZXJlbmNlID0gcHJlZmVyZW5jZXMuZmluZCgocCkgPT4gcC5lbWFpbCA9PT0gZW1haWwgJiYgcC5vcHRPdXQpO1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIGVtYWlsVHlwZTogdHlwZSxcclxuICAgICAgICBvcHRlZE91dDogISFwcmVmZXJlbmNlLFxyXG4gICAgICB9O1xyXG4gICAgfSk7XHJcbiAgfVxyXG59XHJcbiJdLCJ2ZXJzaW9uIjozfQ==