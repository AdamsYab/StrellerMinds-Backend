4e7c2a5c987544b9ed598646364bd5e1
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const typeorm_1 = require("@nestjs/typeorm");
const config_1 = require("@nestjs/config");
const email_service_1 = require("./email.service");
const email_log_entity_1 = require("./entities/email-log.entity");
const email_preference_entity_1 = require("./entities/email-preference.entity");
const email_template_entity_1 = require("./entities/email-template.entity");
describe('EmailService (tracking)', () => {
    let service;
    let emailLogRepo;
    beforeEach(async () => {
        const module = await testing_1.Test.createTestingModule({
            providers: [
                email_service_1.EmailService,
                { provide: config_1.ConfigService, useValue: { get: jest.fn(() => undefined) } },
                { provide: (0, typeorm_1.getRepositoryToken)(email_template_entity_1.EmailTemplate), useValue: {} },
                { provide: (0, typeorm_1.getRepositoryToken)(email_preference_entity_1.EmailPreference), useValue: {} },
                {
                    provide: (0, typeorm_1.getRepositoryToken)(email_log_entity_1.EmailLog),
                    useValue: {
                        findOne: jest.fn(),
                        update: jest.fn(),
                    },
                },
                { provide: 'BullQueue_email', useValue: { add: jest.fn() } },
            ],
        }).compile();
        service = module.get(email_service_1.EmailService);
        emailLogRepo = module.get((0, typeorm_1.getRepositoryToken)(email_log_entity_1.EmailLog));
    });
    describe('markEmailAsOpened', () => {
        it('increments openCount and sets timestamps', async () => {
            const existing = {
                id: '1',
                trackingToken: 'tok',
                openCount: 0,
                firstOpenedAt: null,
            };
            emailLogRepo.findOne.mockResolvedValue(existing);
            emailLogRepo.update.mockResolvedValue({});
            await service.markEmailAsOpened('tok', { userAgent: 'ua', ipAddress: '127.0.0.1' });
            expect(emailLogRepo.update).toHaveBeenCalledWith({ id: '1' }, expect.objectContaining({ openCount: 1, openedAt: expect.any(Date), firstOpenedAt: expect.any(Date) }));
        });
        it('throws for invalid token', async () => {
            emailLogRepo.findOne.mockResolvedValue(null);
            await expect(service.markEmailAsOpened('bad')).rejects.toBeTruthy();
        });
    });
    describe('markEmailAsClicked', () => {
        it('increments clickCount and appends event', async () => {
            const existing = {
                id: '1',
                trackingToken: 'tok',
                clickCount: 0,
                clickEvents: [],
            };
            emailLogRepo.findOne.mockResolvedValue(existing);
            emailLogRepo.update.mockResolvedValue({});
            await service.markEmailAsClicked('tok', 'https://example.com', { userAgent: 'ua', ipAddress: '127.0.0.1' });
            expect(emailLogRepo.update).toHaveBeenCalledWith({ id: '1' }, expect.objectContaining({ clickCount: 1, clickEvents: expect.any(Array) }));
        });
        it('throws for invalid token', async () => {
            emailLogRepo.findOne.mockResolvedValue(null);
            await expect(service.markEmailAsClicked('bad', 'https://x.com')).rejects.toBeTruthy();
        });
    });
    describe('getEmailAnalytics', () => {
        it('returns safe analytics shape', async () => {
            const log = {
                id: '1',
                recipient: 'u@example.com',
                subject: 'Sub',
                createdAt: new Date(),
                firstOpenedAt: null,
                openCount: 0,
                firstClickedAt: new Date(),
                clickCount: 2,
                clickEvents: [{ clickedAt: new Date().toISOString(), url: 'https://x.com' }],
            };
            emailLogRepo.findOne.mockResolvedValue(log);
            const result = await service.getEmailAnalytics('1');
            expect(result).toMatchObject({ id: '1', clicked: true, clickCount: 2 });
            expect(result).not.toHaveProperty('trackingToken');
        });
    });
});
const jwt_1 = require("@nestjs/jwt");
describe('EmailService.verifyUnsubscribeToken', () => {
    let service;
    let config;
    let jwt;
    beforeEach(async () => {
        config = {
            get: jest.fn((key) => {
                if (key === 'UNSUBSCRIBE_JWT_SECRET')
                    return 'secret-x';
                if (key === 'JWT_SECRET')
                    return 'fallback';
                return undefined;
            }),
        };
        jwt = { sign: jest.fn(), verify: jest.fn() };
        const module = await testing_1.Test.createTestingModule({
            providers: [
                email_service_1.EmailService,
                { provide: config_1.ConfigService, useValue: config },
                { provide: 'BullQueue_email', useValue: { add: jest.fn() } },
                { provide: (0, typeorm_1.getRepositoryToken)(email_template_entity_1.EmailTemplate), useValue: {} },
                { provide: (0, typeorm_1.getRepositoryToken)(email_log_entity_1.EmailLog), useValue: {} },
                { provide: (0, typeorm_1.getRepositoryToken)(email_preference_entity_1.EmailPreference), useValue: {} },
                { provide: jwt_1.JwtService, useValue: jwt },
            ],
        }).compile();
        service = module.get(email_service_1.EmailService);
    });
    it('returns true when token payload email matches', async () => {
        jwt.verify.mockReturnValue({ email: 'user@example.com' });
        const ok = await service.verifyUnsubscribeToken('user@example.com', 'tok');
        expect(ok).toBe(true);
    });
    it('returns false on invalid token', async () => {
        jwt.verify.mockImplementation(() => { throw new Error('bad'); });
        const ok = await service.verifyUnsubscribeToken('user@example.com', 'tok');
        expect(ok).toBe(false);
    });
});
describe('EmailService', () => {
    let service;
    let mockQueue;
    const mockEmailTemplateRepo = {
        findOne: jest.fn(),
    };
    const mockEmailLogRepo = {
        create: jest.fn().mockImplementation((data) => data),
        save: jest.fn(),
        update: jest.fn(),
        findOne: jest.fn(),
    };
    const mockEmailPreferenceRepo = {
        findOne: jest.fn(),
        find: jest.fn(),
        create: jest.fn(),
        save: jest.fn(),
    };
    beforeEach(async () => {
        mockQueue = {
            add: jest.fn(),
        };
        const module = await testing_1.Test.createTestingModule({
            providers: [
                email_service_1.EmailService,
                { provide: config_1.ConfigService, useValue: { get: jest.fn(() => 'mock') } },
                { provide: (0, typeorm_1.getRepositoryToken)(email_template_entity_1.EmailTemplate), useValue: mockEmailTemplateRepo },
                { provide: (0, typeorm_1.getRepositoryToken)(email_log_entity_1.EmailLog), useValue: mockEmailLogRepo },
                { provide: (0, typeorm_1.getRepositoryToken)(email_preference_entity_1.EmailPreference), useValue: mockEmailPreferenceRepo },
                { provide: 'BullQueue_email', useValue: mockQueue },
            ],
        }).compile();
        service = module.get(email_service_1.EmailService);
    });
    it('should be defined', () => {
        expect(service).toBeDefined();
    });
    describe('sendEmail', () => {
        it('should queue the email if user has not opted out', async () => {
            mockEmailPreferenceRepo.findOne.mockResolvedValue(null);
            const result = await service.sendEmail({
                to: 'user@example.com',
                subject: 'Test',
                templateName: 'email-verification',
                context: {},
            });
            expect(result).toBe(true);
            expect(mockQueue.add).toHaveBeenCalled();
        });
        it('should not send email if user has opted out', async () => {
            mockEmailPreferenceRepo.findOne.mockResolvedValue({ optOut: true });
            const result = await service.sendEmail({
                to: 'user@example.com',
                subject: 'Test',
                templateName: 'email-verification',
                context: {},
            });
            expect(result).toBe(false);
            expect(mockQueue.add).not.toHaveBeenCalled();
        });
    });
    describe('updateEmailPreference', () => {
        it('should create a new preference if none exists', async () => {
            mockEmailPreferenceRepo.findOne.mockResolvedValue(null);
            await service.updateEmailPreference('user@example.com', 'email-verification', true);
            expect(mockEmailPreferenceRepo.create).toHaveBeenCalled();
            expect(mockEmailPreferenceRepo.save).toHaveBeenCalled();
        });
        it('should update existing preference', async () => {
            mockEmailPreferenceRepo.findOne.mockResolvedValue({ email: 'user@example.com', optOut: false });
            await service.updateEmailPreference('user@example.com', 'email-verification', true);
            expect(mockEmailPreferenceRepo.save).toHaveBeenCalled();
        });
    });
    describe('getTemplate', () => {
        it('should fetch template from database if exists', async () => {
            mockEmailTemplateRepo.findOne.mockResolvedValue({ content: '<p>Hello</p>' });
            const template = await service.getTemplate('email-verification');
            expect(template).toBe('<p>Hello</p>');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxvam9zZXBoXFxEb2N1bWVudHNcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFxlbWFpbFxcZW1haWwuc2VydmljZS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7O0FBQUEsNkNBQXNEO0FBQ3RELDZDQUFxRDtBQUVyRCwyQ0FBK0M7QUFDL0MsbURBQStDO0FBQy9DLGtFQUF1RDtBQUN2RCxnRkFBcUU7QUFDckUsNEVBQWlFO0FBRWpFLFFBQVEsQ0FBQyx5QkFBeUIsRUFBRSxHQUFHLEVBQUU7SUFDdkMsSUFBSSxPQUFxQixDQUFDO0lBQzFCLElBQUksWUFBK0MsQ0FBQztJQUVwRCxVQUFVLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDcEIsTUFBTSxNQUFNLEdBQWtCLE1BQU0sY0FBSSxDQUFDLG1CQUFtQixDQUFDO1lBQzNELFNBQVMsRUFBRTtnQkFDVCw0QkFBWTtnQkFDWixFQUFFLE9BQU8sRUFBRSxzQkFBYSxFQUFFLFFBQVEsRUFBRSxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLFNBQVMsQ0FBQyxFQUFFLEVBQUU7Z0JBQ3ZFLEVBQUUsT0FBTyxFQUFFLElBQUEsNEJBQWtCLEVBQUMscUNBQWEsQ0FBQyxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQUU7Z0JBQzVELEVBQUUsT0FBTyxFQUFFLElBQUEsNEJBQWtCLEVBQUMseUNBQWUsQ0FBQyxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQUU7Z0JBQzlEO29CQUNFLE9BQU8sRUFBRSxJQUFBLDRCQUFrQixFQUFDLDJCQUFRLENBQUM7b0JBQ3JDLFFBQVEsRUFBRTt3QkFDUixPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTt3QkFDbEIsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7cUJBQ2xCO2lCQUNGO2dCQUNELEVBQUUsT0FBTyxFQUFFLGlCQUFpQixFQUFFLFFBQVEsRUFBRSxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRTthQUM3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R0FBRyxFQUFFO1FBQzNCLEVBQUUsQ0FBQywrQ0FBK0MsRUFBRSxLQUFLLElBQUksRUFBRTtZQUM3RCxxQkFBcUIsQ0FBQyxPQUFPLENBQUMsaUJBQWlCLENBQUMsRUFBRSxPQUFPLEVBQUUsY0FBYyxFQUFFLENBQUMsQ0FBQztZQUM3RSxNQUFNLFFBQVEsR0FBRyxNQUFNLE9BQU8sQ0FBQyxXQUFXLENBQUMsb0JBQW9CLENBQUMsQ0FBQztZQUNqRSxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQ3hDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXG9qb3NlcGhcXERvY3VtZW50c1xcU3RyZWxsZXJNaW5kcy1CYWNrZW5kXFxzcmNcXGVtYWlsXFxlbWFpbC5zZXJ2aWNlLnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGVzdCwgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZyc7XHJcbmltcG9ydCB7IGdldFJlcG9zaXRvcnlUb2tlbiB9IGZyb20gJ0BuZXN0anMvdHlwZW9ybSc7XHJcbmltcG9ydCB7IFJlcG9zaXRvcnkgfSBmcm9tICd0eXBlb3JtJztcclxuaW1wb3J0IHsgQ29uZmlnU2VydmljZSB9IGZyb20gJ0BuZXN0anMvY29uZmlnJztcclxuaW1wb3J0IHsgRW1haWxTZXJ2aWNlIH0gZnJvbSAnLi9lbWFpbC5zZXJ2aWNlJztcclxuaW1wb3J0IHsgRW1haWxMb2cgfSBmcm9tICcuL2VudGl0aWVzL2VtYWlsLWxvZy5lbnRpdHknO1xyXG5pbXBvcnQgeyBFbWFpbFByZWZlcmVuY2UgfSBmcm9tICcuL2VudGl0aWVzL2VtYWlsLXByZWZlcmVuY2UuZW50aXR5JztcclxuaW1wb3J0IHsgRW1haWxUZW1wbGF0ZSB9IGZyb20gJy4vZW50aXRpZXMvZW1haWwtdGVtcGxhdGUuZW50aXR5JztcclxuXHJcbmRlc2NyaWJlKCdFbWFpbFNlcnZpY2UgKHRyYWNraW5nKScsICgpID0+IHtcclxuICBsZXQgc2VydmljZTogRW1haWxTZXJ2aWNlO1xyXG4gIGxldCBlbWFpbExvZ1JlcG86IGplc3QuTW9ja2VkPFJlcG9zaXRvcnk8RW1haWxMb2c+PjtcclxuXHJcbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XHJcbiAgICBjb25zdCBtb2R1bGU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xyXG4gICAgICBwcm92aWRlcnM6IFtcclxuICAgICAgICBFbWFpbFNlcnZpY2UsXHJcbiAgICAgICAgeyBwcm92aWRlOiBDb25maWdTZXJ2aWNlLCB1c2VWYWx1ZTogeyBnZXQ6IGplc3QuZm4oKCkgPT4gdW5kZWZpbmVkKSB9IH0sXHJcbiAgICAgICAgeyBwcm92aWRlOiBnZXRSZXBvc2l0b3J5VG9rZW4oRW1haWxUZW1wbGF0ZSksIHVzZVZhbHVlOiB7fSB9LFxyXG4gICAgICAgIHsgcHJvdmlkZTogZ2V0UmVwb3NpdG9yeVRva2VuKEVtYWlsUHJlZmVyZW5jZSksIHVzZVZhbHVlOiB7fSB9LFxyXG4gICAgICAgIHtcclxuICAgICAgICAgIHByb3ZpZGU6IGdldFJlcG9zaXRvcnlUb2tlbihFbWFpbExvZyksXHJcbiAgICAgICAgICB1c2VWYWx1ZToge1xyXG4gICAgICAgICAgICBmaW5kT25lOiBqZXN0LmZuKCksXHJcbiAgICAgICAgICAgIHVwZGF0ZTogamVzdC5mbigpLFxyXG4gICAgICAgICAgfSxcclxuICAgICAgICB9LFxyXG4gICAgICAgIHsgcHJvdmlkZTogJ0J1bGxRdWV1ZV9lbWFpbCcsIHVzZVZhbHVlOiB7IGFkZDogamVzdC5mbigpIH0gfSxcclxuICAgICAgXSxcclxuICAgIH0pLmNvbXBpbGUoKTtcclxuXHJcbiAgICBzZXJ2aWNlID0gbW9kdWxlLmdldDxFbWFpbFNlcnZpY2U+KEVtYWlsU2VydmljZSk7XHJcbiAgICBlbWFpbExvZ1JlcG8gPSBtb2R1bGUuZ2V0KGdldFJlcG9zaXRvcnlUb2tlbihFbWFpbExvZykpO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnbWFya0VtYWlsQXNPcGVuZWQnLCAoKSA9PiB7XHJcbiAgICBpdCgnaW5jcmVtZW50cyBvcGVuQ291bnQgYW5kIHNldHMgdGltZXN0YW1wcycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgZXhpc3Rpbmc6IFBhcnRpYWw8RW1haWxMb2c+ID0ge1xyXG4gICAgICAgIGlkOiAnMScsXHJcbiAgICAgICAgdHJhY2tpbmdUb2tlbjogJ3RvaycsXHJcbiAgICAgICAgb3BlbkNvdW50OiAwLFxyXG4gICAgICAgIGZpcnN0T3BlbmVkQXQ6IG51bGwsXHJcbiAgICAgIH0gYXMgYW55O1xyXG4gICAgICBlbWFpbExvZ1JlcG8uZmluZE9uZS5tb2NrUmVzb2x2ZWRWYWx1ZShleGlzdGluZyBhcyBFbWFpbExvZyk7XHJcbiAgICAgIGVtYWlsTG9nUmVwby51cGRhdGUubW9ja1Jlc29sdmVkVmFsdWUoe30gYXMgYW55KTtcclxuXHJcbiAgICAgIGF3YWl0IHNlcnZpY2UubWFya0VtYWlsQXNPcGVuZWQoJ3RvaycsIHsgdXNlckFnZW50OiAndWEnLCBpcEFkZHJlc3M6ICcxMjcuMC4wLjEnIH0pO1xyXG5cclxuICAgICAgZXhwZWN0KGVtYWlsTG9nUmVwby51cGRhdGUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxyXG4gICAgICAgIHsgaWQ6ICcxJyB9LFxyXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHsgb3BlbkNvdW50OiAxLCBvcGVuZWRBdDogZXhwZWN0LmFueShEYXRlKSwgZmlyc3RPcGVuZWRBdDogZXhwZWN0LmFueShEYXRlKSB9KSxcclxuICAgICAgKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCd0aHJvd3MgZm9yIGludmFsaWQgdG9rZW4nLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGVtYWlsTG9nUmVwby5maW5kT25lLm1vY2tSZXNvbHZlZFZhbHVlKG51bGwpO1xyXG4gICAgICBhd2FpdCBleHBlY3Qoc2VydmljZS5tYXJrRW1haWxBc09wZW5lZCgnYmFkJykpLnJlamVjdHMudG9CZVRydXRoeSgpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdtYXJrRW1haWxBc0NsaWNrZWQnLCAoKSA9PiB7XHJcbiAgICBpdCgnaW5jcmVtZW50cyBjbGlja0NvdW50IGFuZCBhcHBlbmRzIGV2ZW50JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBleGlzdGluZzogUGFydGlhbDxFbWFpbExvZz4gPSB7XHJcbiAgICAgICAgaWQ6ICcxJyxcclxuICAgICAgICB0cmFja2luZ1Rva2VuOiAndG9rJyxcclxuICAgICAgICBjbGlja0NvdW50OiAwLFxyXG4gICAgICAgIGNsaWNrRXZlbnRzOiBbXSxcclxuICAgICAgfSBhcyBhbnk7XHJcbiAgICAgIGVtYWlsTG9nUmVwby5maW5kT25lLm1vY2tSZXNvbHZlZFZhbHVlKGV4aXN0aW5nIGFzIEVtYWlsTG9nKTtcclxuICAgICAgZW1haWxMb2dSZXBvLnVwZGF0ZS5tb2NrUmVzb2x2ZWRWYWx1ZSh7fSBhcyBhbnkpO1xyXG5cclxuICAgICAgYXdhaXQgc2VydmljZS5tYXJrRW1haWxBc0NsaWNrZWQoJ3RvaycsICdodHRwczovL2V4YW1wbGUuY29tJywgeyB1c2VyQWdlbnQ6ICd1YScsIGlwQWRkcmVzczogJzEyNy4wLjAuMScgfSk7XHJcblxyXG4gICAgICBleHBlY3QoZW1haWxMb2dSZXBvLnVwZGF0ZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXHJcbiAgICAgICAgeyBpZDogJzEnIH0sXHJcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoeyBjbGlja0NvdW50OiAxLCBjbGlja0V2ZW50czogZXhwZWN0LmFueShBcnJheSkgfSksXHJcbiAgICAgICk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgndGhyb3dzIGZvciBpbnZhbGlkIHRva2VuJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBlbWFpbExvZ1JlcG8uZmluZE9uZS5tb2NrUmVzb2x2ZWRWYWx1ZShudWxsKTtcclxuICAgICAgYXdhaXQgZXhwZWN0KHNlcnZpY2UubWFya0VtYWlsQXNDbGlja2VkKCdiYWQnLCAnaHR0cHM6Ly94LmNvbScpKS5yZWplY3RzLnRvQmVUcnV0aHkoKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnZ2V0RW1haWxBbmFseXRpY3MnLCAoKSA9PiB7XHJcbiAgICBpdCgncmV0dXJucyBzYWZlIGFuYWx5dGljcyBzaGFwZScsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgbG9nOiBQYXJ0aWFsPEVtYWlsTG9nPiA9IHtcclxuICAgICAgICBpZDogJzEnLFxyXG4gICAgICAgIHJlY2lwaWVudDogJ3VAZXhhbXBsZS5jb20nLFxyXG4gICAgICAgIHN1YmplY3Q6ICdTdWInLFxyXG4gICAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKSxcclxuICAgICAgICBmaXJzdE9wZW5lZEF0OiBudWxsLFxyXG4gICAgICAgIG9wZW5Db3VudDogMCxcclxuICAgICAgICBmaXJzdENsaWNrZWRBdDogbmV3IERhdGUoKSxcclxuICAgICAgICBjbGlja0NvdW50OiAyLFxyXG4gICAgICAgIGNsaWNrRXZlbnRzOiBbeyBjbGlja2VkQXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwgdXJsOiAnaHR0cHM6Ly94LmNvbScgfV0sXHJcbiAgICAgIH0gYXMgYW55O1xyXG4gICAgICBlbWFpbExvZ1JlcG8uZmluZE9uZS5tb2NrUmVzb2x2ZWRWYWx1ZShsb2cgYXMgRW1haWxMb2cpO1xyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLmdldEVtYWlsQW5hbHl0aWNzKCcxJyk7XHJcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvTWF0Y2hPYmplY3QoeyBpZDogJzEnLCBjbGlja2VkOiB0cnVlLCBjbGlja0NvdW50OiAyIH0pO1xyXG4gICAgICBleHBlY3QocmVzdWx0KS5ub3QudG9IYXZlUHJvcGVydHkoJ3RyYWNraW5nVG9rZW4nKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG59KTtcclxuXHJcbmltcG9ydCB7IFRlc3QsIFRlc3RpbmdNb2R1bGUgfSBmcm9tICdAbmVzdGpzL3Rlc3RpbmcnO1xyXG5pbXBvcnQgeyBDb25maWdTZXJ2aWNlIH0gZnJvbSAnQG5lc3Rqcy9jb25maWcnO1xyXG5pbXBvcnQgeyBFbWFpbFNlcnZpY2UgfSBmcm9tICcuL2VtYWlsLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBnZXRSZXBvc2l0b3J5VG9rZW4gfSBmcm9tICdAbmVzdGpzL3R5cGVvcm0nO1xyXG5pbXBvcnQgeyBFbWFpbFRlbXBsYXRlIH0gZnJvbSAnLi9lbnRpdGllcy9lbWFpbC10ZW1wbGF0ZS5lbnRpdHknO1xyXG5pbXBvcnQgeyBFbWFpbExvZyB9IGZyb20gJy4vZW50aXRpZXMvZW1haWwtbG9nLmVudGl0eSc7XHJcbmltcG9ydCB7IEVtYWlsUHJlZmVyZW5jZSB9IGZyb20gJy4vZW50aXRpZXMvZW1haWwtcHJlZmVyZW5jZS5lbnRpdHknO1xyXG5pbXBvcnQgeyBRdWV1ZSB9IGZyb20gJ2J1bGwnO1xyXG5pbXBvcnQgeyBKd3RTZXJ2aWNlIH0gZnJvbSAnQG5lc3Rqcy9qd3QnO1xyXG5cclxuZGVzY3JpYmUoJ0VtYWlsU2VydmljZS52ZXJpZnlVbnN1YnNjcmliZVRva2VuJywgKCkgPT4ge1xyXG4gIGxldCBzZXJ2aWNlOiBFbWFpbFNlcnZpY2U7XHJcbiAgbGV0IGNvbmZpZzogUGFydGlhbDxDb25maWdTZXJ2aWNlPjtcclxuICBsZXQgand0OiB7IHNpZ246IGplc3QuTW9jazsgdmVyaWZ5OiBqZXN0Lk1vY2sgfTtcclxuXHJcbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XHJcbiAgICBjb25maWcgPSB7XHJcbiAgICAgIGdldDogamVzdC5mbigoa2V5OiBzdHJpbmcpID0+IHtcclxuICAgICAgICBpZiAoa2V5ID09PSAnVU5TVUJTQ1JJQkVfSldUX1NFQ1JFVCcpIHJldHVybiAnc2VjcmV0LXgnO1xyXG4gICAgICAgIGlmIChrZXkgPT09ICdKV1RfU0VDUkVUJykgcmV0dXJuICdmYWxsYmFjayc7XHJcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgICAgfSksXHJcbiAgICB9IGFzIGFueTtcclxuXHJcbiAgICBqd3QgPSB7IHNpZ246IGplc3QuZm4oKSwgdmVyaWZ5OiBqZXN0LmZuKCkgfTtcclxuXHJcbiAgICBjb25zdCBtb2R1bGU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xyXG4gICAgICBwcm92aWRlcnM6IFtcclxuICAgICAgICBFbWFpbFNlcnZpY2UsXHJcbiAgICAgICAgeyBwcm92aWRlOiBDb25maWdTZXJ2aWNlLCB1c2VWYWx1ZTogY29uZmlnIH0sXHJcbiAgICAgICAgeyBwcm92aWRlOiAnQnVsbFF1ZXVlX2VtYWlsJywgdXNlVmFsdWU6IHsgYWRkOiBqZXN0LmZuKCkgfSBhcyBQYXJ0aWFsPFF1ZXVlPiB9LFxyXG4gICAgICAgIHsgcHJvdmlkZTogZ2V0UmVwb3NpdG9yeVRva2VuKEVtYWlsVGVtcGxhdGUpLCB1c2VWYWx1ZToge30gfSxcclxuICAgICAgICB7IHByb3ZpZGU6IGdldFJlcG9zaXRvcnlUb2tlbihFbWFpbExvZyksIHVzZVZhbHVlOiB7fSB9LFxyXG4gICAgICAgIHsgcHJvdmlkZTogZ2V0UmVwb3NpdG9yeVRva2VuKEVtYWlsUHJlZmVyZW5jZSksIHVzZVZhbHVlOiB7fSB9LFxyXG4gICAgICAgIHsgcHJvdmlkZTogSnd0U2VydmljZSwgdXNlVmFsdWU6IGp3dCB9LFxyXG4gICAgICBdLFxyXG4gICAgfSkuY29tcGlsZSgpO1xyXG5cclxuICAgIHNlcnZpY2UgPSBtb2R1bGUuZ2V0KEVtYWlsU2VydmljZSk7XHJcbiAgfSk7XHJcblxyXG4gIGl0KCdyZXR1cm5zIHRydWUgd2hlbiB0b2tlbiBwYXlsb2FkIGVtYWlsIG1hdGNoZXMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICBqd3QudmVyaWZ5Lm1vY2tSZXR1cm5WYWx1ZSh7IGVtYWlsOiAndXNlckBleGFtcGxlLmNvbScgfSk7XHJcbiAgICBjb25zdCBvayA9IGF3YWl0IHNlcnZpY2UudmVyaWZ5VW5zdWJzY3JpYmVUb2tlbigndXNlckBleGFtcGxlLmNvbScsICd0b2snKTtcclxuICAgIGV4cGVjdChvaykudG9CZSh0cnVlKTtcclxuICB9KTtcclxuXHJcbiAgaXQoJ3JldHVybnMgZmFsc2Ugb24gaW52YWxpZCB0b2tlbicsIGFzeW5jICgpID0+IHtcclxuICAgIGp3dC52ZXJpZnkubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IHsgdGhyb3cgbmV3IEVycm9yKCdiYWQnKTsgfSk7XHJcbiAgICBjb25zdCBvayA9IGF3YWl0IHNlcnZpY2UudmVyaWZ5VW5zdWJzY3JpYmVUb2tlbigndXNlckBleGFtcGxlLmNvbScsICd0b2snKTtcclxuICAgIGV4cGVjdChvaykudG9CZShmYWxzZSk7XHJcbiAgfSk7XHJcbn0pO1xyXG5cclxuaW1wb3J0IHsgVGVzdCwgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZyc7XHJcbmltcG9ydCB7IEVtYWlsU2VydmljZSB9IGZyb20gJy4vZW1haWwuc2VydmljZSc7XHJcbmltcG9ydCB7IGdldFJlcG9zaXRvcnlUb2tlbiB9IGZyb20gJ0BuZXN0anMvdHlwZW9ybSc7XHJcbmltcG9ydCB7IEVtYWlsVGVtcGxhdGUgfSBmcm9tICcuL2VudGl0aWVzL2VtYWlsLXRlbXBsYXRlLmVudGl0eSc7XHJcbmltcG9ydCB7IEVtYWlsTG9nIH0gZnJvbSAnLi9lbnRpdGllcy9lbWFpbC1sb2cuZW50aXR5JztcclxuaW1wb3J0IHsgRW1haWxQcmVmZXJlbmNlIH0gZnJvbSAnLi9lbnRpdGllcy9lbWFpbC1wcmVmZXJlbmNlLmVudGl0eSc7XHJcbmltcG9ydCB7IENvbmZpZ1NlcnZpY2UgfSBmcm9tICdAbmVzdGpzL2NvbmZpZyc7XHJcbmltcG9ydCB7IFF1ZXVlIH0gZnJvbSAnYnVsbCc7XHJcblxyXG5kZXNjcmliZSgnRW1haWxTZXJ2aWNlJywgKCkgPT4ge1xyXG4gIGxldCBzZXJ2aWNlOiBFbWFpbFNlcnZpY2U7XHJcbiAgbGV0IG1vY2tRdWV1ZTogUXVldWU7XHJcblxyXG4gIGNvbnN0IG1vY2tFbWFpbFRlbXBsYXRlUmVwbyA9IHtcclxuICAgIGZpbmRPbmU6IGplc3QuZm4oKSxcclxuICB9O1xyXG4gIGNvbnN0IG1vY2tFbWFpbExvZ1JlcG8gPSB7XHJcbiAgICBjcmVhdGU6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKGRhdGEpID0+IGRhdGEpLFxyXG4gICAgc2F2ZTogamVzdC5mbigpLFxyXG4gICAgdXBkYXRlOiBqZXN0LmZuKCksXHJcbiAgICBmaW5kT25lOiBqZXN0LmZuKCksXHJcbiAgfTtcclxuICBjb25zdCBtb2NrRW1haWxQcmVmZXJlbmNlUmVwbyA9IHtcclxuICAgIGZpbmRPbmU6IGplc3QuZm4oKSxcclxuICAgIGZpbmQ6IGplc3QuZm4oKSxcclxuICAgIGNyZWF0ZTogamVzdC5mbigpLFxyXG4gICAgc2F2ZTogamVzdC5mbigpLFxyXG4gIH07XHJcblxyXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xyXG4gICAgbW9ja1F1ZXVlID0ge1xyXG4gICAgICBhZGQ6IGplc3QuZm4oKSxcclxuICAgIH0gYXMgYW55O1xyXG5cclxuICAgIGNvbnN0IG1vZHVsZTogVGVzdGluZ01vZHVsZSA9IGF3YWl0IFRlc3QuY3JlYXRlVGVzdGluZ01vZHVsZSh7XHJcbiAgICAgIHByb3ZpZGVyczogW1xyXG4gICAgICAgIEVtYWlsU2VydmljZSxcclxuICAgICAgICB7IHByb3ZpZGU6IENvbmZpZ1NlcnZpY2UsIHVzZVZhbHVlOiB7IGdldDogamVzdC5mbigoKSA9PiAnbW9jaycpIH0gfSxcclxuICAgICAgICB7IHByb3ZpZGU6IGdldFJlcG9zaXRvcnlUb2tlbihFbWFpbFRlbXBsYXRlKSwgdXNlVmFsdWU6IG1vY2tFbWFpbFRlbXBsYXRlUmVwbyB9LFxyXG4gICAgICAgIHsgcHJvdmlkZTogZ2V0UmVwb3NpdG9yeVRva2VuKEVtYWlsTG9nKSwgdXNlVmFsdWU6IG1vY2tFbWFpbExvZ1JlcG8gfSxcclxuICAgICAgICB7IHByb3ZpZGU6IGdldFJlcG9zaXRvcnlUb2tlbihFbWFpbFByZWZlcmVuY2UpLCB1c2VWYWx1ZTogbW9ja0VtYWlsUHJlZmVyZW5jZVJlcG8gfSxcclxuICAgICAgICB7IHByb3ZpZGU6ICdCdWxsUXVldWVfZW1haWwnLCB1c2VWYWx1ZTogbW9ja1F1ZXVlIH0sXHJcbiAgICAgIF0sXHJcbiAgICB9KS5jb21waWxlKCk7XHJcblxyXG4gICAgc2VydmljZSA9IG1vZHVsZS5nZXQ8RW1haWxTZXJ2aWNlPihFbWFpbFNlcnZpY2UpO1xyXG4gIH0pO1xyXG5cclxuICBpdCgnc2hvdWxkIGJlIGRlZmluZWQnLCAoKSA9PiB7XHJcbiAgICBleHBlY3Qoc2VydmljZSkudG9CZURlZmluZWQoKTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ3NlbmRFbWFpbCcsICgpID0+IHtcclxuICAgIGl0KCdzaG91bGQgcXVldWUgdGhlIGVtYWlsIGlmIHVzZXIgaGFzIG5vdCBvcHRlZCBvdXQnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIG1vY2tFbWFpbFByZWZlcmVuY2VSZXBvLmZpbmRPbmUubW9ja1Jlc29sdmVkVmFsdWUobnVsbCk7XHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2Uuc2VuZEVtYWlsKHtcclxuICAgICAgICB0bzogJ3VzZXJAZXhhbXBsZS5jb20nLFxyXG4gICAgICAgIHN1YmplY3Q6ICdUZXN0JyxcclxuICAgICAgICB0ZW1wbGF0ZU5hbWU6ICdlbWFpbC12ZXJpZmljYXRpb24nLFxyXG4gICAgICAgIGNvbnRleHQ6IHt9LFxyXG4gICAgICB9KTtcclxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZSh0cnVlKTtcclxuICAgICAgZXhwZWN0KG1vY2tRdWV1ZS5hZGQpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgbm90IHNlbmQgZW1haWwgaWYgdXNlciBoYXMgb3B0ZWQgb3V0JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBtb2NrRW1haWxQcmVmZXJlbmNlUmVwby5maW5kT25lLm1vY2tSZXNvbHZlZFZhbHVlKHsgb3B0T3V0OiB0cnVlIH0pO1xyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLnNlbmRFbWFpbCh7XHJcbiAgICAgICAgdG86ICd1c2VyQGV4YW1wbGUuY29tJyxcclxuICAgICAgICBzdWJqZWN0OiAnVGVzdCcsXHJcbiAgICAgICAgdGVtcGxhdGVOYW1lOiAnZW1haWwtdmVyaWZpY2F0aW9uJyxcclxuICAgICAgICBjb250ZXh0OiB7fSxcclxuICAgICAgfSk7XHJcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoZmFsc2UpO1xyXG4gICAgICBleHBlY3QobW9ja1F1ZXVlLmFkZCkubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgndXBkYXRlRW1haWxQcmVmZXJlbmNlJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCBjcmVhdGUgYSBuZXcgcHJlZmVyZW5jZSBpZiBub25lIGV4aXN0cycsIGFzeW5jICgpID0+IHtcclxuICAgICAgbW9ja0VtYWlsUHJlZmVyZW5jZVJlcG8uZmluZE9uZS5tb2NrUmVzb2x2ZWRWYWx1ZShudWxsKTtcclxuICAgICAgYXdhaXQgc2VydmljZS51cGRhdGVFbWFpbFByZWZlcmVuY2UoJ3VzZXJAZXhhbXBsZS5jb20nLCAnZW1haWwtdmVyaWZpY2F0aW9uJywgdHJ1ZSk7XHJcbiAgICAgIGV4cGVjdChtb2NrRW1haWxQcmVmZXJlbmNlUmVwby5jcmVhdGUpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgICAgZXhwZWN0KG1vY2tFbWFpbFByZWZlcmVuY2VSZXBvLnNhdmUpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgdXBkYXRlIGV4aXN0aW5nIHByZWZlcmVuY2UnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIG1vY2tFbWFpbFByZWZlcmVuY2VSZXBvLmZpbmRPbmUubW9ja1Jlc29sdmVkVmFsdWUoeyBlbWFpbDogJ3VzZXJAZXhhbXBsZS5jb20nLCBvcHRPdXQ6IGZhbHNlIH0pO1xyXG4gICAgICBhd2FpdCBzZXJ2aWNlLnVwZGF0ZUVtYWlsUHJlZmVyZW5jZSgndXNlckBleGFtcGxlLmNvbScsICdlbWFpbC12ZXJpZmljYXRpb24nLCB0cnVlKTtcclxuICAgICAgZXhwZWN0KG1vY2tFbWFpbFByZWZlcmVuY2VSZXBvLnNhdmUpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnZ2V0VGVtcGxhdGUnLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIGZldGNoIHRlbXBsYXRlIGZyb20gZGF0YWJhc2UgaWYgZXhpc3RzJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBtb2NrRW1haWxUZW1wbGF0ZVJlcG8uZmluZE9uZS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IGNvbnRlbnQ6ICc8cD5IZWxsbzwvcD4nIH0pO1xyXG4gICAgICBjb25zdCB0ZW1wbGF0ZSA9IGF3YWl0IHNlcnZpY2UuZ2V0VGVtcGxhdGUoJ2VtYWlsLXZlcmlmaWNhdGlvbicpO1xyXG4gICAgICBleHBlY3QodGVtcGxhdGUpLnRvQmUoJzxwPkhlbGxvPC9wPicpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcbn0pO1xyXG4iXSwidmVyc2lvbiI6M30=