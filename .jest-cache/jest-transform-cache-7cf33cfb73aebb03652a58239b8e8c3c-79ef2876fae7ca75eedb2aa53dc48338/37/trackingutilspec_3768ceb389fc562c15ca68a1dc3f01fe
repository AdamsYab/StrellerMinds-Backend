37c5af4e2a389225aad59a1bf1b5cb44
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const config_1 = require("@nestjs/config");
const tracking_util_1 = require("./tracking.util");
describe('EmailTrackingUtil', () => {
    let util;
    const mockSecret = 'test-secret-key-minimum-32-characters-long';
    const mockBaseUrl = 'http://localhost:3000';
    beforeEach(async () => {
        const module = await testing_1.Test.createTestingModule({
            providers: [
                tracking_util_1.EmailTrackingUtil,
                {
                    provide: config_1.ConfigService,
                    useValue: {
                        get: jest.fn((key) => {
                            if (key === 'EMAIL_TRACKING_SECRET')
                                return mockSecret;
                            if (key === 'EMAIL_TRACKING_BASE_URL')
                                return mockBaseUrl;
                            return undefined;
                        }),
                    },
                },
            ],
        }).compile();
        util = module.get(tracking_util_1.EmailTrackingUtil);
    });
    it('generateTrackingToken returns 64 hex chars and uniqueness', () => {
        const t1 = util.generateTrackingToken();
        const t2 = util.generateTrackingToken();
        expect(t1).toHaveLength(64);
        expect(t1).toMatch(/^[a-f0-9]{64}$/);
        expect(t1).not.toBe(t2);
    });
    it('signUrl is deterministic and sensitive to inputs', () => {
        const a = util.signUrl('token123', 'https://example.com');
        const b = util.signUrl('token123', 'https://example.com');
        const c = util.signUrl('token456', 'https://example.com');
        expect(a).toBe(b);
        expect(a).not.toBe(c);
    });
    it('verifySignature validates correct signatures and rejects invalid', () => {
        const token = 'token123';
        const url = 'https://example.com';
        const sig = util.signUrl(token, url);
        expect(util.verifySignature(token, url, sig)).toBe(true);
        expect(util.verifySignature(token, url, 'bad')).toBe(false);
        expect(util.verifySignature(token, 'https://bad.com', sig)).toBe(false);
    });
    it('injectOpenTracking appends or injects pixel', () => {
        const htmlWithBody = '<html><body><p>Test</p></body></html>';
        const res1 = util.injectOpenTracking(htmlWithBody, 'abc');
        expect(res1).toContain('/email/track/open/abc.png');
        expect(res1.indexOf('</body>')).toBeGreaterThan(res1.indexOf('<img'));
        const html = '<p>Test</p>';
        const res2 = util.injectOpenTracking(html, 'abc');
        expect(res2).toContain('/email/track/open/abc.png');
    });
    it('injectClickTracking wraps links and skips mailto/tel/#', () => {
        const html = `
      <a href="https://example.com">A</a>
      <a href="mailto:test@example.com">B</a>
      <a href="#anchor">C</a>
      <a href="tel:+123">D</a>
    `;
        const res = util.injectClickTracking(html, 'tok');
        expect(res).toContain('/email/track/click/tok');
        expect(res).toContain('url=https%3A%2F%2Fexample.com');
        // unchanged others
        expect(res).toContain('mailto:test@example.com');
        expect(res).toContain('#anchor');
        expect(res).toContain('tel:+123');
    });
    it('addTrackingToEmail includes both click and open', () => {
        const input = '<html><body><a href="https://ex.com">X</a></body></html>';
        const out = util.addTrackingToEmail(input, 'tok');
        expect(out).toContain('/email/track/click/tok');
        expect(out).toContain('/email/track/open/tok.png');
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxvam9zZXBoXFxEb2N1bWVudHNcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFxlbWFpbFxcdXRpbHNcXHRyYWNraW5nLnV0aWwuc3BlYy50cyIsIm1hcHBpbmdzIjoiOztBQUFBLDZDQUFzRDtBQUN0RCwyQ0FBK0M7QUFDL0MsbURBQW9EO0FBRXBELFFBQVEsQ0FBQyxtQkFBbUIsRUFBRSxHQUFHLEVBQUU7SUFDakMsSUFBSSxJQUF1QixDQUFDO0lBQzVCLE1BQU0sVUFBVSxHQUFHLDRDQUE0QyxDQUFDO0lBQ2hFLE1BQU0sV0FBVyxHQUFHLHVCQUF1QixDQUFDO0lBRTVDLFVBQVUsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNwQixNQUFNLE1BQU0sR0FBa0IsTUFBTSxjQUFJLENBQUMsbUJBQW1CLENBQUM7WUFDM0QsU0FBUyxFQUFFO2dCQUNULGlDQUFpQjtnQkFDakI7b0JBQ0UsT0FBTyxFQUFFLHNCQUFhO29CQUN0QixRQUFRLEVBQUU7d0JBQ1IsR0FBRyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFXLEVBQUUsRUFBRTs0QkFDM0IsSUFBSSxHQUFHLEtBQUssdUJBQXVCO2dDQUFFLE9BQU8sVUFBVSxDQUFDOzRCQUN2RCxJQUFJLEdBQUcsS0FBSyx5QkFBeUI7Z0NBQUUsT0FBTyxXQUFXLENBQUM7NEJBQzFELE9BQU8sU0FBUyxDQUFDO3dCQUNuQixDQUFDLENBQUM7cUJBQ0g7aUJBQ0Y7YUFDRjtTQUNGLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUViLElBQUksR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFvQixpQ0FBaUIsQ0FBQyxDQUFDO0lBQzFELENBQUMsQ0FBQyxDQUFDO0lBRUgsRUFBRSxDQUFDLDJEQUEyRCxFQUFFLEdBQUcsRUFBRTtRQUNuRSxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQztRQUN4QyxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQztRQUN4QyxNQUFNLENB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UUFDdkQsbUJBQW1CO1FBQ25CLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxTQUFTLENBQUMseUJBQXlCLENBQUMsQ0FBQztRQUNqRCxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ2pDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDcEMsQ0FBQyxDQUFDLENBQUM7SUFFSCxFQUFFLENBQUMsaURBQWlELEVBQUUsR0FBRyxFQUFFO1FBQ3pELE1BQU0sS0FBSyxHQUFHLDBEQUEwRCxDQUFDO1FBQ3pFLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDbEQsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLFNBQVMsQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO1FBQ2hELE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxTQUFTLENBQUMsMkJBQTJCLENBQUMsQ0FBQztJQUNyRCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcb2pvc2VwaFxcRG9jdW1lbnRzXFxTdHJlbGxlck1pbmRzLUJhY2tlbmRcXHNyY1xcZW1haWxcXHV0aWxzXFx0cmFja2luZy51dGlsLnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGVzdCwgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZyc7XHJcbmltcG9ydCB7IENvbmZpZ1NlcnZpY2UgfSBmcm9tICdAbmVzdGpzL2NvbmZpZyc7XHJcbmltcG9ydCB7IEVtYWlsVHJhY2tpbmdVdGlsIH0gZnJvbSAnLi90cmFja2luZy51dGlsJztcclxuXHJcbmRlc2NyaWJlKCdFbWFpbFRyYWNraW5nVXRpbCcsICgpID0+IHtcclxuICBsZXQgdXRpbDogRW1haWxUcmFja2luZ1V0aWw7XHJcbiAgY29uc3QgbW9ja1NlY3JldCA9ICd0ZXN0LXNlY3JldC1rZXktbWluaW11bS0zMi1jaGFyYWN0ZXJzLWxvbmcnO1xyXG4gIGNvbnN0IG1vY2tCYXNlVXJsID0gJ2h0dHA6Ly9sb2NhbGhvc3Q6MzAwMCc7XHJcblxyXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xyXG4gICAgY29uc3QgbW9kdWxlOiBUZXN0aW5nTW9kdWxlID0gYXdhaXQgVGVzdC5jcmVhdGVUZXN0aW5nTW9kdWxlKHtcclxuICAgICAgcHJvdmlkZXJzOiBbXHJcbiAgICAgICAgRW1haWxUcmFja2luZ1V0aWwsXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgcHJvdmlkZTogQ29uZmlnU2VydmljZSxcclxuICAgICAgICAgIHVzZVZhbHVlOiB7XHJcbiAgICAgICAgICAgIGdldDogamVzdC5mbigoa2V5OiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgICAgICBpZiAoa2V5ID09PSAnRU1BSUxfVFJBQ0tJTkdfU0VDUkVUJykgcmV0dXJuIG1vY2tTZWNyZXQ7XHJcbiAgICAgICAgICAgICAgaWYgKGtleSA9PT0gJ0VNQUlMX1RSQUNLSU5HX0JBU0VfVVJMJykgcmV0dXJuIG1vY2tCYXNlVXJsO1xyXG4gICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgfSxcclxuICAgICAgICB9LFxyXG4gICAgICBdLFxyXG4gICAgfSkuY29tcGlsZSgpO1xyXG5cclxuICAgIHV0aWwgPSBtb2R1bGUuZ2V0PEVtYWlsVHJhY2tpbmdVdGlsPihFbWFpbFRyYWNraW5nVXRpbCk7XHJcbiAgfSk7XHJcblxyXG4gIGl0KCdnZW5lcmF0ZVRyYWNraW5nVG9rZW4gcmV0dXJucyA2NCBoZXggY2hhcnMgYW5kIHVuaXF1ZW5lc3MnLCAoKSA9PiB7XHJcbiAgICBjb25zdCB0MSA9IHV0aWwuZ2VuZXJhdGVUcmFja2luZ1Rva2VuKCk7XHJcbiAgICBjb25zdCB0MiA9IHV0aWwuZ2VuZXJhdGVUcmFja2luZ1Rva2VuKCk7XHJcbiAgICBleHBlY3QodDEpLnRvSGF2ZUxlbmd0aCg2NCk7XHJcbiAgICBleHBlY3QodDEpLnRvTWF0Y2goL15bYS1mMC05XXs2NH0kLyk7XHJcbiAgICBleHBlY3QodDEpLm5vdC50b0JlKHQyKTtcclxuICB9KTtcclxuXHJcbiAgaXQoJ3NpZ25VcmwgaXMgZGV0ZXJtaW5pc3RpYyBhbmQgc2Vuc2l0aXZlIHRvIGlucHV0cycsICgpID0+IHtcclxuICAgIGNvbnN0IGEgPSB1dGlsLnNpZ25VcmwoJ3Rva2VuMTIzJywgJ2h0dHBzOi8vZXhhbXBsZS5jb20nKTtcclxuICAgIGNvbnN0IGIgPSB1dGlsLnNpZ25VcmwoJ3Rva2VuMTIzJywgJ2h0dHBzOi8vZXhhbXBsZS5jb20nKTtcclxuICAgIGNvbnN0IGMgPSB1dGlsLnNpZ25VcmwoJ3Rva2VuNDU2JywgJ2h0dHBzOi8vZXhhbXBsZS5jb20nKTtcclxuICAgIGV4cGVjdChhKS50b0JlKGIpO1xyXG4gICAgZXhwZWN0KGEpLm5vdC50b0JlKGMpO1xyXG4gIH0pO1xyXG5cclxuICBpdCgndmVyaWZ5U2lnbmF0dXJlIHZhbGlkYXRlcyBjb3JyZWN0IHNpZ25hdHVyZXMgYW5kIHJlamVjdHMgaW52YWxpZCcsICgpID0+IHtcclxuICAgIGNvbnN0IHRva2VuID0gJ3Rva2VuMTIzJztcclxuICAgIGNvbnN0IHVybCA9ICdodHRwczovL2V4YW1wbGUuY29tJztcclxuICAgIGNvbnN0IHNpZyA9IHV0aWwuc2lnblVybCh0b2tlbiwgdXJsKTtcclxuICAgIGV4cGVjdCh1dGlsLnZlcmlmeVNpZ25hdHVyZSh0b2tlbiwgdXJsLCBzaWcpKS50b0JlKHRydWUpO1xyXG4gICAgZXhwZWN0KHV0aWwudmVyaWZ5U2lnbmF0dXJlKHRva2VuLCB1cmwsICdiYWQnKSkudG9CZShmYWxzZSk7XHJcbiAgICBleHBlY3QodXRpbC52ZXJpZnlTaWduYXR1cmUodG9rZW4sICdodHRwczovL2JhZC5jb20nLCBzaWcpKS50b0JlKGZhbHNlKTtcclxuICB9KTtcclxuXHJcbiAgaXQoJ2luamVjdE9wZW5UcmFja2luZyBhcHBlbmRzIG9yIGluamVjdHMgcGl4ZWwnLCAoKSA9PiB7XHJcbiAgICBjb25zdCBodG1sV2l0aEJvZHkgPSAnPGh0bWw+PGJvZHk+PHA+VGVzdDwvcD48L2JvZHk+PC9odG1sPic7XHJcbiAgICBjb25zdCByZXMxID0gdXRpbC5pbmplY3RPcGVuVHJhY2tpbmcoaHRtbFdpdGhCb2R5LCAnYWJjJyk7XHJcbiAgICBleHBlY3QocmVzMSkudG9Db250YWluKCcvZW1haWwvdHJhY2svb3Blbi9hYmMucG5nJyk7XHJcbiAgICBleHBlY3QocmVzMS5pbmRleE9mKCc8L2JvZHk+JykpLnRvQmVHcmVhdGVyVGhhbihyZXMxLmluZGV4T2YoJzxpbWcnKSk7XHJcblxyXG4gICAgY29uc3QgaHRtbCA9ICc8cD5UZXN0PC9wPic7XHJcbiAgICBjb25zdCByZXMyID0gdXRpbC5pbmplY3RPcGVuVHJhY2tpbmcoaHRtbCwgJ2FiYycpO1xyXG4gICAgZXhwZWN0KHJlczIpLnRvQ29udGFpbignL2VtYWlsL3RyYWNrL29wZW4vYWJjLnBuZycpO1xyXG4gIH0pO1xyXG5cclxuICBpdCgnaW5qZWN0Q2xpY2tUcmFja2luZyB3cmFwcyBsaW5rcyBhbmQgc2tpcHMgbWFpbHRvL3RlbC8jJywgKCkgPT4ge1xyXG4gICAgY29uc3QgaHRtbCA9IGBcclxuICAgICAgPGEgaHJlZj1cImh0dHBzOi8vZXhhbXBsZS5jb21cIj5BPC9hPlxyXG4gICAgICA8YSBocmVmPVwibWFpbHRvOnRlc3RAZXhhbXBsZS5jb21cIj5CPC9hPlxyXG4gICAgICA8YSBocmVmPVwiI2FuY2hvclwiPkM8L2E+XHJcbiAgICAgIDxhIGhyZWY9XCJ0ZWw6KzEyM1wiPkQ8L2E+XHJcbiAgICBgO1xyXG4gICAgY29uc3QgcmVzID0gdXRpbC5pbmplY3RDbGlja1RyYWNraW5nKGh0bWwsICd0b2snKTtcclxuICAgIGV4cGVjdChyZXMpLnRvQ29udGFpbignL2VtYWlsL3RyYWNrL2NsaWNrL3RvaycpO1xyXG4gICAgZXhwZWN0KHJlcykudG9Db250YWluKCd1cmw9aHR0cHMlM0ElMkYlMkZleGFtcGxlLmNvbScpO1xyXG4gICAgLy8gdW5jaGFuZ2VkIG90aGVyc1xyXG4gICAgZXhwZWN0KHJlcykudG9Db250YWluKCdtYWlsdG86dGVzdEBleGFtcGxlLmNvbScpO1xyXG4gICAgZXhwZWN0KHJlcykudG9Db250YWluKCcjYW5jaG9yJyk7XHJcbiAgICBleHBlY3QocmVzKS50b0NvbnRhaW4oJ3RlbDorMTIzJyk7XHJcbiAgfSk7XHJcblxyXG4gIGl0KCdhZGRUcmFja2luZ1RvRW1haWwgaW5jbHVkZXMgYm90aCBjbGljayBhbmQgb3BlbicsICgpID0+IHtcclxuICAgIGNvbnN0IGlucHV0ID0gJzxodG1sPjxib2R5PjxhIGhyZWY9XCJodHRwczovL2V4LmNvbVwiPlg8L2E+PC9ib2R5PjwvaHRtbD4nO1xyXG4gICAgY29uc3Qgb3V0ID0gdXRpbC5hZGRUcmFja2luZ1RvRW1haWwoaW5wdXQsICd0b2snKTtcclxuICAgIGV4cGVjdChvdXQpLnRvQ29udGFpbignL2VtYWlsL3RyYWNrL2NsaWNrL3RvaycpO1xyXG4gICAgZXhwZWN0KG91dCkudG9Db250YWluKCcvZW1haWwvdHJhY2svb3Blbi90b2sucG5nJyk7XHJcbiAgfSk7XHJcbn0pO1xyXG5cclxuXHJcbiJdLCJ2ZXJzaW9uIjozfQ==