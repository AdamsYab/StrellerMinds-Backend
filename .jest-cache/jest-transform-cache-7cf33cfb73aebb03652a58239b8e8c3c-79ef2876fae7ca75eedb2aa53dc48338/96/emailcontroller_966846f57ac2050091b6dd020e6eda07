c522e09a619fbfff89490d6b3fdece6f
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var EmailController_1;
var _a, _b, _c, _d, _e, _f, _g, _h, _j;
Object.defineProperty(exports, "__esModule", { value: true });
exports.EmailController = void 0;
/**
 * EmailController handles endpoints for managing email preferences, analytics, and tracking.
 */
const common_1 = require("@nestjs/common");
const swagger_1 = require("@nestjs/swagger");
const email_service_1 = require("./email.service");
const email_preference_entity_1 = require("./entities/email-preference.entity");
const express_1 = require("express");
const tracking_util_1 = require("./utils/tracking.util");
const jwt_auth_guard_1 = require("../auth/guards/jwt-auth.guard");
let EmailController = EmailController_1 = class EmailController {
    constructor(emailService, trackingUtil) {
        this.emailService = emailService;
        this.trackingUtil = trackingUtil;
        this.logger = new common_1.Logger(EmailController_1.name);
    }
    /**
     * Track email open via transparent pixel
     */
    async trackOpen(token, req, res) {
        try {
            const metadata = {
                userAgent: req.headers['user-agent']?.toString().substring(0, 255),
                ipAddress: this.getClientIp(req),
            };
            await this.emailService.markEmailAsOpened(token, metadata);
            const pixel = Buffer.from('iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==', 'base64');
            res.writeHead(200, {
                'Content-Type': 'image/png',
                'Content-Length': pixel.length,
                'Cache-Control': 'no-store, no-cache, must-revalidate, private',
                'Pragma': 'no-cache',
                'Expires': '0',
                'X-Content-Type-Options': 'nosniff',
                'X-Frame-Options': 'DENY',
                'Referrer-Policy': 'no-referrer',
            });
            res.end(pixel);
        }
        catch (error) {
            this.logger.error(`Error tracking email open: ${error.message}`);
            const pixel = Buffer.from('iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==', 'base64');
            res.writeHead(200, {
                'Content-Type': 'image/png',
                'Content-Length': pixel.length,
            });
            res.end(pixel);
        }
    }
    /**
     * Track email click and redirect
     */
    async trackClick(token, encodedUrl, signature, req, res) {
        try {
            const targetUrl = decodeURIComponent(encodedUrl);
            const isValid = this.trackingUtil.verifySignature(token, targetUrl, signature);
            if (!isValid) {
                this.logger.warn(`Invalid tracking signature for token: ${token}`);
                throw new common_1.ForbiddenException('Invalid tracking signature');
            }
            const metadata = {
                userAgent: req.headers['user-agent']?.toString().substring(0, 255),
                ipAddress: this.getClientIp(req),
            };
            await this.emailService.markEmailAsClicked(token, targetUrl, metadata);
            res.redirect(302, targetUrl);
        }
        catch (error) {
            if (error instanceof common_1.ForbiddenException) {
                throw error;
            }
            this.logger.error(`Error tracking email click: ${error.message}`);
            res.redirect(302, '/');
        }
    }
    /**
     * Get email analytics (protected)
     */
    async getAnalytics(emailId) {
        return this.emailService.getEmailAnalytics(emailId);
    }
    getClientIp(req) {
        const forwarded = req.headers['x-forwarded-for'];
        if (typeof forwarded === 'string') {
            return forwarded.split(',')[0].trim();
        }
        return req.socket?.remoteAddress || 'unknown';
    }
    /**
     * Update a user's email preference for a specific email type.
     * @param body - Email, emailType, and optOut flag
     * @returns The updated EmailPreference entity
     */
    async updatePreference(body) {
        return this.emailService.updateEmailPreference(body.email, body.emailType, body.optOut);
    }
    /**
     * Get email analytics for a date range and optional template name.
     * @param startDate - Start date (ISO8601)
     * @param endDate - End date (ISO8601)
     * @param templateName - Optional template name
     * @returns Analytics data
     */
    async getAnalytics(startDate, endDate, templateName) {
        return this.emailService.getEmailAnalytics(new Date(startDate), new Date(endDate), templateName);
    }
    /**
     * Track email open event (returns a 1x1 transparent pixel).
     * @param id - Email log ID
     * @param res - Response object
     */
    async trackOpen(id, res) {
        try {
            // Update the email log to mark as opened
            await this.emailService.markEmailAsOpened(id);
            // Return a 1x1 transparent pixel
            const buffer = Buffer.from('R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7', 'base64');
            res.set('Content-Type', 'image/gif');
            res.set('Cache-Control', 'no-store, no-cache, must-revalidate, proxy-revalidate');
            res.set('Pragma', 'no-cache');
            res.set('Expires', '0');
            return res.send(buffer);
        }
        catch (error) {
            // Still return the pixel even if tracking fails
            const buffer = Buffer.from('R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7', 'base64');
            res.set('Content-Type', 'image/gif');
            return res.send(buffer);
        }
    }
    // This endpoint would be used for tracking email clicks
    async trackClick(id, url, res) {
        try {
            // Update the email log to mark as clicked
            await this.emailService.markEmailAsClicked(id, url);
        }
        catch (error) {
            // Log the error but continue with the redirect
            console.error('Error tracking click:', error);
        }
        // Redirect to the original URL
        return res.redirect(url);
    }
};
exports.EmailController = EmailController;
__decorate([
    (0, common_1.Get)('track/open/:token.png'),
    (0, swagger_1.ApiOperation)({ summary: 'Track email open via pixel' }),
    (0, swagger_1.ApiParam)({ name: 'token', description: 'Email tracking token' }),
    __param(0, (0, common_1.Param)('token')),
    __param(1, (0, common_1.Req)()),
    __param(2, (0, common_1.Res)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, typeof (_c = typeof express_1.Request !== "undefined" && express_1.Request) === "function" ? _c : Object, typeof (_d = typeof express_1.Response !== "undefined" && express_1.Response) === "function" ? _d : Object]),
    __metadata("design:returntype", typeof (_e = typeof Promise !== "undefined" && Promise) === "function" ? _e : Object)
], EmailController.prototype, "trackOpen", null);
__decorate([
    (0, common_1.Get)('track/click/:token'),
    (0, swagger_1.ApiOperation)({ summary: 'Track email click and redirect' }),
    (0, swagger_1.ApiParam)({ name: 'token', description: 'Email tracking token' }),
    (0, swagger_1.ApiQuery)({ name: 'url', description: 'Target URL (encoded)' }),
    (0, swagger_1.ApiQuery)({ name: 'sig', description: 'HMAC signature' }),
    __param(0, (0, common_1.Param)('token')),
    __param(1, (0, common_1.Query)('url')),
    __param(2, (0, common_1.Query)('sig')),
    __param(3, (0, common_1.Req)()),
    __param(4, (0, common_1.Res)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String, String, typeof (_f = typeof express_1.Request !== "undefined" && express_1.Request) === "function" ? _f : Object, typeof (_g = typeof express_1.Response !== "undefined" && express_1.Response) === "function" ? _g : Object]),
    __metadata("design:returntype", typeof (_h = typeof Promise !== "undefined" && Promise) === "function" ? _h : Object)
], EmailController.prototype, "trackClick", null);
__decorate([
    (0, common_1.Get)('track/analytics/:emailId'),
    (0, common_1.UseGuards)(jwt_auth_guard_1.JwtAuthGuard),
    (0, swagger_1.ApiOperation)({ summary: 'Get email tracking analytics' }),
    (0, swagger_1.ApiParam)({ name: 'emailId', description: 'Email log ID' }),
    __param(0, (0, common_1.Param)('emailId')),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String]),
    __metadata("design:returntype", Promise)
], EmailController.prototype, "getAnalytics", null);
__decorate([
    (0, common_1.Post)('preferences'),
    (0, swagger_1.ApiOperation)({ summary: 'Update email preference', description: 'Update a user\'s email preference for a specific email type.' }),
    (0, swagger_1.ApiBody)({ schema: { properties: { email: { type: 'string' }, emailType: { type: 'string' }, optOut: { type: 'boolean' } } } }),
    (0, swagger_1.ApiResponse)({ status: 200, description: 'Email preference updated', type: email_preference_entity_1.EmailPreference }),
    __param(0, (0, common_1.Body)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object]),
    __metadata("design:returntype", typeof (_j = typeof Promise !== "undefined" && Promise) === "function" ? _j : Object)
], EmailController.prototype, "updatePreference", null);
__decorate([
    (0, common_1.Get)('analytics'),
    (0, swagger_1.ApiOperation)({ summary: 'Get email analytics', description: 'Get email analytics for a date range and optional template name.' }),
    (0, swagger_1.ApiQuery)({ name: 'startDate', required: true, description: 'Start date (ISO8601)' }),
    (0, swagger_1.ApiQuery)({ name: 'endDate', required: true, description: 'End date (ISO8601)' }),
    (0, swagger_1.ApiQuery)({ name: 'templateName', required: false, description: 'Template name' }),
    (0, swagger_1.ApiResponse)({ status: 200, description: 'Email analytics data' }),
    __param(0, (0, common_1.Query)('startDate')),
    __param(1, (0, common_1.Query)('endDate')),
    __param(2, (0, common_1.Query)('templateName')),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String, String]),
    __metadata("design:returntype", Promise)
], EmailController.prototype, "getAnalytics", null);
__decorate([
    (0, common_1.Get)('track/open/:id'),
    (0, swagger_1.ApiOperation)({ summary: 'Track email open', description: 'Track email open event (returns a 1x1 transparent pixel).' }),
    (0, swagger_1.ApiParam)({ name: 'id', description: 'Email log ID' }),
    (0, swagger_1.ApiResponse)({ status: 200, description: '1x1 transparent pixel returned' }),
    __param(0, (0, common_1.Param)('id')),
    __param(1, (0, common_1.Res)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, Object]),
    __metadata("design:returntype", Promise)
], EmailController.prototype, "trackOpen", null);
__decorate([
    (0, common_1.Get)('track/click/:id'),
    __param(0, (0, common_1.Param)('id')),
    __param(1, (0, common_1.Query)('url')),
    __param(2, (0, common_1.Res)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String, Object]),
    __metadata("design:returntype", Promise)
], EmailController.prototype, "trackClick", null);
exports.EmailController = EmailController = EmailController_1 = __decorate([
    (0, swagger_1.ApiTags)('Email'),
    (0, common_1.Controller)('email'),
    __metadata("design:paramtypes", [typeof (_a = typeof email_service_1.EmailService !== "undefined" && email_service_1.EmailService) === "function" ? _a : Object, typeof (_b = typeof tracking_util_1.EmailTrackingUtil !== "undefined" && tracking_util_1.EmailTrackingUtil) === "function" ? _b : Object])
], EmailController);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxvam9zZXBoXFxEb2N1bWVudHNcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFxlbWFpbFxcZW1haWwuY29udHJvbGxlci50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztHQUVHO0FBQ0gsMkNBQTRIO0FBQzVILDZDQUFrRztBQUNsRyxtREFBK0M7QUFDL0MsZ0ZBQXFFO0FBQ3JFLHFDQUE0QztBQUM1Qyx5REFBMEQ7QUFDMUQsa0VBQTZEO0FBSXRELElBQU0sZUFBZSx1QkFBckIsTUFBTSxlQUFlO0lBRzFCLFlBQ21CLFlBQTBCLEVBQzFCLFlBQStCO1FBRC9CLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLGlCQUFZLEdBQVosWUFBWSxDQUFtQjtRQUpqQyxXQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMsaUJBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUt4RCxDQUFDO0lBQ0o7O09BRUc7SUFJRyxBQUFOLEtBQUssQ0FBQyxTQUFTLENBQ0csS0FBYSxFQUN0QixHQUFZLEVBQ1osR0FBYTtRQUVwQixJQUFJLENBQUM7WUFDSCxNQUFNLFFBQVEsR0FBRztnQkFDZixTQUFTLEVBQUUsR0FBRyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsRUFBRSxRQUFRLEVBQUUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQztnQkFDbEUsU0FBUyxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDO2FBQ2pDLENBQUM7WUFFRixNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsaUJBQWlCLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBRTNELE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQ3ZCLGtHQUFrRyxFQUNsRyxRQUFRLENBQ1QsQ0FBQztZQUVGLEdBQUcsQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFO2dCQUNqQixjQUFjLEVBQUUsV0FBVztnQkFDM0IsZ0JBQWdCLEVBQUUsS0FBSyxDQUFDLE1BQU07Z0JB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RSxDQUFDO0lBRS9ELFdBQUEsSUFBQSxjQUFLLEVBQUMsV0FBVyxDQUFDLENBQUE7SUFDbEIsV0FBQSxJQUFBLGNBQUssRUFBQyxTQUFTLENBQUMsQ0FBQTtJQUNoQixXQUFBLElBQUEsY0FBSyxFQUFDLGNBQWMsQ0FBQyxDQUFBOzs7O21EQU92QjtBQVdLO0lBSkwsSUFBQSxZQUFHLEVBQUMsZ0JBQWdCLENBQUM7SUFDckIsSUFBQSxzQkFBWSxFQUFDLEVBQUUsT0FBTyxFQUFFLGtCQUFrQixFQUFFLFdBQVcsRUFBRSwyREFBMkQsRUFBRSxDQUFDO0lBQ3ZILElBQUEsa0JBQVEsRUFBQyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsV0FBVyxFQUFFLGNBQWMsRUFBRSxDQUFDO0lBQ3JELElBQUEscUJBQVcsRUFBQyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsV0FBVyxFQUFFLGdDQUFnQyxFQUFFLENBQUM7SUFDM0QsV0FBQSxJQUFBLGNBQUssRUFBQyxJQUFJLENBQUMsQ0FBQTtJQUFjLFdBQUEsSUFBQSxZQUFHLEdBQUUsQ0FBQTs7OztnREE2QjlDO0FBSUs7SUFETCxJQUFBLFlBQUcsRUFBQyxpQkFBaUIsQ0FBQztJQUVwQixXQUFBLElBQUEsY0FBSyxFQUFDLElBQUksQ0FBQyxDQUFBO0lBQ1gsV0FBQSxJQUFBLGNBQUssRUFBQyxLQUFLLENBQUMsQ0FBQTtJQUNaLFdBQUEsSUFBQSxZQUFHLEdBQUUsQ0FBQTs7OztpREFZUDswQkF6TlUsZUFBZTtJQUYzQixJQUFBLGlCQUFPLEVBQUMsT0FBTyxDQUFDO0lBQ2hCLElBQUEsbUJBQVUsRUFBQyxPQUFPLENBQUM7eURBS2UsNEJBQVksb0JBQVosNEJBQVksb0RBQ1osaUNBQWlCLG9CQUFqQixpQ0FBaUI7R0FMdkMsZUFBZSxDQTBOM0IiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxvam9zZXBoXFxEb2N1bWVudHNcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFxlbWFpbFxcZW1haWwuY29udHJvbGxlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogRW1haWxDb250cm9sbGVyIGhhbmRsZXMgZW5kcG9pbnRzIGZvciBtYW5hZ2luZyBlbWFpbCBwcmVmZXJlbmNlcywgYW5hbHl0aWNzLCBhbmQgdHJhY2tpbmcuXHJcbiAqL1xyXG5pbXBvcnQgeyBDb250cm9sbGVyLCBHZXQsIFBvc3QsIEJvZHksIFBhcmFtLCBRdWVyeSwgUmVzLCBSZXEsIEZvcmJpZGRlbkV4Y2VwdGlvbiwgTG9nZ2VyLCBVc2VHdWFyZHMgfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XHJcbmltcG9ydCB7IEFwaVRhZ3MsIEFwaU9wZXJhdGlvbiwgQXBpUmVzcG9uc2UsIEFwaUJvZHksIEFwaVBhcmFtLCBBcGlRdWVyeSB9IGZyb20gJ0BuZXN0anMvc3dhZ2dlcic7XHJcbmltcG9ydCB7IEVtYWlsU2VydmljZSB9IGZyb20gJy4vZW1haWwuc2VydmljZSc7XHJcbmltcG9ydCB7IEVtYWlsUHJlZmVyZW5jZSB9IGZyb20gJy4vZW50aXRpZXMvZW1haWwtcHJlZmVyZW5jZS5lbnRpdHknO1xyXG5pbXBvcnQgeyBSZXNwb25zZSwgUmVxdWVzdCB9IGZyb20gJ2V4cHJlc3MnO1xyXG5pbXBvcnQgeyBFbWFpbFRyYWNraW5nVXRpbCB9IGZyb20gJy4vdXRpbHMvdHJhY2tpbmcudXRpbCc7XHJcbmltcG9ydCB7IEp3dEF1dGhHdWFyZCB9IGZyb20gJy4uL2F1dGgvZ3VhcmRzL2p3dC1hdXRoLmd1YXJkJztcclxuXHJcbkBBcGlUYWdzKCdFbWFpbCcpXHJcbkBDb250cm9sbGVyKCdlbWFpbCcpXHJcbmV4cG9ydCBjbGFzcyBFbWFpbENvbnRyb2xsZXIge1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyID0gbmV3IExvZ2dlcihFbWFpbENvbnRyb2xsZXIubmFtZSk7XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSByZWFkb25seSBlbWFpbFNlcnZpY2U6IEVtYWlsU2VydmljZSxcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgdHJhY2tpbmdVdGlsOiBFbWFpbFRyYWNraW5nVXRpbCxcclxuICApIHt9XHJcbiAgLyoqXHJcbiAgICogVHJhY2sgZW1haWwgb3BlbiB2aWEgdHJhbnNwYXJlbnQgcGl4ZWxcclxuICAgKi9cclxuICBAR2V0KCd0cmFjay9vcGVuLzp0b2tlbi5wbmcnKVxyXG4gIEBBcGlPcGVyYXRpb24oeyBzdW1tYXJ5OiAnVHJhY2sgZW1haWwgb3BlbiB2aWEgcGl4ZWwnIH0pXHJcbiAgQEFwaVBhcmFtKHsgbmFtZTogJ3Rva2VuJywgZGVzY3JpcHRpb246ICdFbWFpbCB0cmFja2luZyB0b2tlbicgfSlcclxuICBhc3luYyB0cmFja09wZW4oXHJcbiAgICBAUGFyYW0oJ3Rva2VuJykgdG9rZW46IHN0cmluZyxcclxuICAgIEBSZXEoKSByZXE6IFJlcXVlc3QsXHJcbiAgICBAUmVzKCkgcmVzOiBSZXNwb25zZSxcclxuICApOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IG1ldGFkYXRhID0ge1xyXG4gICAgICAgIHVzZXJBZ2VudDogcmVxLmhlYWRlcnNbJ3VzZXItYWdlbnQnXT8udG9TdHJpbmcoKS5zdWJzdHJpbmcoMCwgMjU1KSxcclxuICAgICAgICBpcEFkZHJlc3M6IHRoaXMuZ2V0Q2xpZW50SXAocmVxKSxcclxuICAgICAgfTtcclxuXHJcbiAgICAgIGF3YWl0IHRoaXMuZW1haWxTZXJ2aWNlLm1hcmtFbWFpbEFzT3BlbmVkKHRva2VuLCBtZXRhZGF0YSk7XHJcblxyXG4gICAgICBjb25zdCBwaXhlbCA9IEJ1ZmZlci5mcm9tKFxyXG4gICAgICAgICdpVkJPUncwS0dnb0FBQUFOU1VoRVVnQUFBQUVBQUFBQkNBWUFBQUFmRmNTSkFBQUFEVWxFUVZSNDJtTmtZUGhmRHdBQ2h3R0E2MGU2a2dBQUFBQkpSVTVFcmtKZ2dnPT0nLFxyXG4gICAgICAgICdiYXNlNjQnXHJcbiAgICAgICk7XHJcblxyXG4gICAgICByZXMud3JpdGVIZWFkKDIwMCwge1xyXG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnaW1hZ2UvcG5nJyxcclxuICAgICAgICAnQ29udGVudC1MZW5ndGgnOiBwaXhlbC5sZW5ndGgsXHJcbiAgICAgICAgJ0NhY2hlLUNvbnRyb2wnOiAnbm8tc3RvcmUsIG5vLWNhY2hlLCBtdXN0LXJldmFsaWRhdGUsIHByaXZhdGUnLFxyXG4gICAgICAgICdQcmFnbWEnOiAnbm8tY2FjaGUnLFxyXG4gICAgICAgICdFeHBpcmVzJzogJzAnLFxyXG4gICAgICAgICdYLUNvbnRlbnQtVHlwZS1PcHRpb25zJzogJ25vc25pZmYnLFxyXG4gICAgICAgICdYLUZyYW1lLU9wdGlvbnMnOiAnREVOWScsXHJcbiAgICAgICAgJ1JlZmVycmVyLVBvbGljeSc6ICduby1yZWZlcnJlcicsXHJcbiAgICAgIH0pO1xyXG4gICAgICByZXMuZW5kKHBpeGVsKTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGBFcnJvciB0cmFja2luZyBlbWFpbCBvcGVuOiAke2Vycm9yLm1lc3NhZ2V9YCk7XHJcbiAgICAgIGNvbnN0IHBpeGVsID0gQnVmZmVyLmZyb20oXHJcbiAgICAgICAgJ2lWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFBRUFBQUFCQ0FZQUFBQWZGY1NKQUFBQURVbEVRVlI0Mm1Oa1lQaGZEd0FDaHdHQTYwZTZrZ0FBQUFCSlJVNUVya0pnZ2c9PScsXHJcbiAgICAgICAgJ2Jhc2U2NCdcclxuICAgICAgKTtcclxuICAgICAgcmVzLndyaXRlSGVhZCgyMDAsIHtcclxuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2ltYWdlL3BuZycsXHJcbiAgICAgICAgJ0NvbnRlbnQtTGVuZ3RoJzogcGl4ZWwubGVuZ3RoLFxyXG4gICAgICB9KTtcclxuICAgICAgcmVzLmVuZChwaXhlbCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBUcmFjayBlbWFpbCBjbGljayBhbmQgcmVkaXJlY3RcclxuICAgKi9cclxuICBAR2V0KCd0cmFjay9jbGljay86dG9rZW4nKVxyXG4gIEBBcGlPcGVyYXRpb24oeyBzdW1tYXJ5OiAnVHJhY2sgZW1haWwgY2xpY2sgYW5kIHJlZGlyZWN0JyB9KVxyXG4gIEBBcGlQYXJhbSh7IG5hbWU6ICd0b2tlbicsIGRlc2NyaXB0aW9uOiAnRW1haWwgdHJhY2tpbmcgdG9rZW4nIH0pXHJcbiAgQEFwaVF1ZXJ5KHsgbmFtZTogJ3VybCcsIGRlc2NyaXB0aW9uOiAnVGFyZ2V0IFVSTCAoZW5jb2RlZCknIH0pXHJcbiAgQEFwaVF1ZXJ5KHsgbmFtZTogJ3NpZycsIGRlc2NyaXB0aW9uOiAnSE1BQyBzaWduYXR1cmUnIH0pXHJcbiAgYXN5bmMgdHJhY2tDbGljayhcclxuICAgIEBQYXJhbSgndG9rZW4nKSB0b2tlbjogc3RyaW5nLFxyXG4gICAgQFF1ZXJ5KCd1cmwnKSBlbmNvZGVkVXJsOiBzdHJpbmcsXHJcbiAgICBAUXVlcnkoJ3NpZycpIHNpZ25hdHVyZTogc3RyaW5nLFxyXG4gICAgQFJlcSgpIHJlcTogUmVxdWVzdCxcclxuICAgIEBSZXMoKSByZXM6IFJlc3BvbnNlLFxyXG4gICk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgdGFyZ2V0VXJsID0gZGVjb2RlVVJJQ29tcG9uZW50KGVuY29kZWRVcmwpO1xyXG5cclxuICAgICAgY29uc3QgaXNWYWxpZCA9IHRoaXMudHJhY2tpbmdVdGlsLnZlcmlmeVNpZ25hdHVyZSh0b2tlbiwgdGFyZ2V0VXJsLCBzaWduYXR1cmUpO1xyXG4gICAgICBpZiAoIWlzVmFsaWQpIHtcclxuICAgICAgICB0aGlzLmxvZ2dlci53YXJuKGBJbnZhbGlkIHRyYWNraW5nIHNpZ25hdHVyZSBmb3IgdG9rZW46ICR7dG9rZW59YCk7XHJcbiAgICAgICAgdGhyb3cgbmV3IEZvcmJpZGRlbkV4Y2VwdGlvbignSW52YWxpZCB0cmFja2luZyBzaWduYXR1cmUnKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3QgbWV0YWRhdGEgPSB7XHJcbiAgICAgICAgdXNlckFnZW50OiByZXEuaGVhZGVyc1sndXNlci1hZ2VudCddPy50b1N0cmluZygpLnN1YnN0cmluZygwLCAyNTUpLFxyXG4gICAgICAgIGlwQWRkcmVzczogdGhpcy5nZXRDbGllbnRJcChyZXEpLFxyXG4gICAgICB9O1xyXG5cclxuICAgICAgYXdhaXQgdGhpcy5lbWFpbFNlcnZpY2UubWFya0VtYWlsQXNDbGlja2VkKHRva2VuLCB0YXJnZXRVcmwsIG1ldGFkYXRhKTtcclxuXHJcbiAgICAgIHJlcy5yZWRpcmVjdCgzMDIsIHRhcmdldFVybCk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBGb3JiaWRkZW5FeGNlcHRpb24pIHtcclxuICAgICAgICB0aHJvdyBlcnJvcjtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihgRXJyb3IgdHJhY2tpbmcgZW1haWwgY2xpY2s6ICR7ZXJyb3IubWVzc2FnZX1gKTtcclxuICAgICAgcmVzLnJlZGlyZWN0KDMwMiwgJy8nKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdldCBlbWFpbCBhbmFseXRpY3MgKHByb3RlY3RlZClcclxuICAgKi9cclxuICBAR2V0KCd0cmFjay9hbmFseXRpY3MvOmVtYWlsSWQnKVxyXG4gIEBVc2VHdWFyZHMoSnd0QXV0aEd1YXJkKVxyXG4gIEBBcGlPcGVyYXRpb24oeyBzdW1tYXJ5OiAnR2V0IGVtYWlsIHRyYWNraW5nIGFuYWx5dGljcycgfSlcclxuICBAQXBpUGFyYW0oeyBuYW1lOiAnZW1haWxJZCcsIGRlc2NyaXB0aW9uOiAnRW1haWwgbG9nIElEJyB9KVxyXG4gIGFzeW5jIGdldEFuYWx5dGljcyhAUGFyYW0oJ2VtYWlsSWQnKSBlbWFpbElkOiBzdHJpbmcpIHtcclxuICAgIHJldHVybiB0aGlzLmVtYWlsU2VydmljZS5nZXRFbWFpbEFuYWx5dGljcyhlbWFpbElkKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0Q2xpZW50SXAocmVxOiBSZXF1ZXN0KTogc3RyaW5nIHtcclxuICAgIGNvbnN0IGZvcndhcmRlZCA9IHJlcS5oZWFkZXJzWyd4LWZvcndhcmRlZC1mb3InXTtcclxuICAgIGlmICh0eXBlb2YgZm9yd2FyZGVkID09PSAnc3RyaW5nJykge1xyXG4gICAgICByZXR1cm4gZm9yd2FyZGVkLnNwbGl0KCcsJylbMF0udHJpbSgpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIChyZXEuc29ja2V0IGFzIGFueSk/LnJlbW90ZUFkZHJlc3MgfHwgJ3Vua25vd24nO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogVXBkYXRlIGEgdXNlcidzIGVtYWlsIHByZWZlcmVuY2UgZm9yIGEgc3BlY2lmaWMgZW1haWwgdHlwZS5cclxuICAgKiBAcGFyYW0gYm9keSAtIEVtYWlsLCBlbWFpbFR5cGUsIGFuZCBvcHRPdXQgZmxhZ1xyXG4gICAqIEByZXR1cm5zIFRoZSB1cGRhdGVkIEVtYWlsUHJlZmVyZW5jZSBlbnRpdHlcclxuICAgKi9cclxuICBAUG9zdCgncHJlZmVyZW5jZXMnKVxyXG4gIEBBcGlPcGVyYXRpb24oeyBzdW1tYXJ5OiAnVXBkYXRlIGVtYWlsIHByZWZlcmVuY2UnLCBkZXNjcmlwdGlvbjogJ1VwZGF0ZSBhIHVzZXJcXCdzIGVtYWlsIHByZWZlcmVuY2UgZm9yIGEgc3BlY2lmaWMgZW1haWwgdHlwZS4nIH0pXHJcbiAgQEFwaUJvZHkoeyBzY2hlbWE6IHsgcHJvcGVydGllczogeyBlbWFpbDogeyB0eXBlOiAnc3RyaW5nJyB9LCBlbWFpbFR5cGU6IHsgdHlwZTogJ3N0cmluZycgfSwgb3B0T3V0OiB7IHR5cGU6ICdib29sZWFuJyB9IH0gfSB9KVxyXG4gIEBBcGlSZXNwb25zZSh7IHN0YXR1czogMjAwLCBkZXNjcmlwdGlvbjogJ0VtYWlsIHByZWZlcmVuY2UgdXBkYXRlZCcsIHR5cGU6IEVtYWlsUHJlZmVyZW5jZSB9KVxyXG4gIGFzeW5jIHVwZGF0ZVByZWZlcmVuY2UoXHJcbiAgICBAQm9keSgpIGJvZHk6IHsgZW1haWw6IHN0cmluZzsgZW1haWxUeXBlOiBzdHJpbmc7IG9wdE91dDogYm9vbGVhbiB9LFxyXG4gICk6IFByb21pc2U8RW1haWxQcmVmZXJlbmNlPiB7XHJcbiAgICByZXR1cm4gdGhpcy5lbWFpbFNlcnZpY2UudXBkYXRlRW1haWxQcmVmZXJlbmNlKFxyXG4gICAgICBib2R5LmVtYWlsLFxyXG4gICAgICBib2R5LmVtYWlsVHlwZSxcclxuICAgICAgYm9keS5vcHRPdXQsXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogR2V0IGVtYWlsIGFuYWx5dGljcyBmb3IgYSBkYXRlIHJhbmdlIGFuZCBvcHRpb25hbCB0ZW1wbGF0ZSBuYW1lLlxyXG4gICAqIEBwYXJhbSBzdGFydERhdGUgLSBTdGFydCBkYXRlIChJU084NjAxKVxyXG4gICAqIEBwYXJhbSBlbmREYXRlIC0gRW5kIGRhdGUgKElTTzg2MDEpXHJcbiAgICogQHBhcmFtIHRlbXBsYXRlTmFtZSAtIE9wdGlvbmFsIHRlbXBsYXRlIG5hbWVcclxuICAgKiBAcmV0dXJucyBBbmFseXRpY3MgZGF0YVxyXG4gICAqL1xyXG4gIEBHZXQoJ2FuYWx5dGljcycpXHJcbiAgQEFwaU9wZXJhdGlvbih7IHN1bW1hcnk6ICdHZXQgZW1haWwgYW5hbHl0aWNzJywgZGVzY3JpcHRpb246ICdHZXQgZW1haWwgYW5hbHl0aWNzIGZvciBhIGRhdGUgcmFuZ2UgYW5kIG9wdGlvbmFsIHRlbXBsYXRlIG5hbWUuJyB9KVxyXG4gIEBBcGlRdWVyeSh7IG5hbWU6ICdzdGFydERhdGUnLCByZXF1aXJlZDogdHJ1ZSwgZGVzY3JpcHRpb246ICdTdGFydCBkYXRlIChJU084NjAxKScgfSlcclxuICBAQXBpUXVlcnkoeyBuYW1lOiAnZW5kRGF0ZScsIHJlcXVpcmVkOiB0cnVlLCBkZXNjcmlwdGlvbjogJ0VuZCBkYXRlIChJU084NjAxKScgfSlcclxuICBAQXBpUXVlcnkoeyBuYW1lOiAndGVtcGxhdGVOYW1lJywgcmVxdWlyZWQ6IGZhbHNlLCBkZXNjcmlwdGlvbjogJ1RlbXBsYXRlIG5hbWUnIH0pXHJcbiAgQEFwaVJlc3BvbnNlKHsgc3RhdHVzOiAyMDAsIGRlc2NyaXB0aW9uOiAnRW1haWwgYW5hbHl0aWNzIGRhdGEnIH0pXHJcbiAgYXN5bmMgZ2V0QW5hbHl0aWNzKFxyXG4gICAgQFF1ZXJ5KCdzdGFydERhdGUnKSBzdGFydERhdGU6IHN0cmluZyxcclxuICAgIEBRdWVyeSgnZW5kRGF0ZScpIGVuZERhdGU6IHN0cmluZyxcclxuICAgIEBRdWVyeSgndGVtcGxhdGVOYW1lJykgdGVtcGxhdGVOYW1lPzogc3RyaW5nLFxyXG4gICkge1xyXG4gICAgcmV0dXJuIHRoaXMuZW1haWxTZXJ2aWNlLmdldEVtYWlsQW5hbHl0aWNzKFxyXG4gICAgICBuZXcgRGF0ZShzdGFydERhdGUpLFxyXG4gICAgICBuZXcgRGF0ZShlbmREYXRlKSxcclxuICAgICAgdGVtcGxhdGVOYW1lLFxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFRyYWNrIGVtYWlsIG9wZW4gZXZlbnQgKHJldHVybnMgYSAxeDEgdHJhbnNwYXJlbnQgcGl4ZWwpLlxyXG4gICAqIEBwYXJhbSBpZCAtIEVtYWlsIGxvZyBJRFxyXG4gICAqIEBwYXJhbSByZXMgLSBSZXNwb25zZSBvYmplY3RcclxuICAgKi9cclxuICBAR2V0KCd0cmFjay9vcGVuLzppZCcpXHJcbiAgQEFwaU9wZXJhdGlvbih7IHN1bW1hcnk6ICdUcmFjayBlbWFpbCBvcGVuJywgZGVzY3JpcHRpb246ICdUcmFjayBlbWFpbCBvcGVuIGV2ZW50IChyZXR1cm5zIGEgMXgxIHRyYW5zcGFyZW50IHBpeGVsKS4nIH0pXHJcbiAgQEFwaVBhcmFtKHsgbmFtZTogJ2lkJywgZGVzY3JpcHRpb246ICdFbWFpbCBsb2cgSUQnIH0pXHJcbiAgQEFwaVJlc3BvbnNlKHsgc3RhdHVzOiAyMDAsIGRlc2NyaXB0aW9uOiAnMXgxIHRyYW5zcGFyZW50IHBpeGVsIHJldHVybmVkJyB9KVxyXG4gIGFzeW5jIHRyYWNrT3BlbihAUGFyYW0oJ2lkJykgaWQ6IHN0cmluZywgQFJlcygpIHJlcykge1xyXG4gICAgdHJ5IHtcclxuICAgICAgLy8gVXBkYXRlIHRoZSBlbWFpbCBsb2cgdG8gbWFyayBhcyBvcGVuZWRcclxuICAgICAgYXdhaXQgdGhpcy5lbWFpbFNlcnZpY2UubWFya0VtYWlsQXNPcGVuZWQoaWQpO1xyXG5cclxuICAgICAgLy8gUmV0dXJuIGEgMXgxIHRyYW5zcGFyZW50IHBpeGVsXHJcbiAgICAgIGNvbnN0IGJ1ZmZlciA9IEJ1ZmZlci5mcm9tKFxyXG4gICAgICAgICdSMGxHT0RsaEFRQUJBSUFBQUFBQUFQLy8veUg1QkFFQUFBQUFMQUFBQUFBQkFBRUFBQUlCUkFBNycsXHJcbiAgICAgICAgJ2Jhc2U2NCcsXHJcbiAgICAgICk7XHJcblxyXG4gICAgICByZXMuc2V0KCdDb250ZW50LVR5cGUnLCAnaW1hZ2UvZ2lmJyk7XHJcbiAgICAgIHJlcy5zZXQoXHJcbiAgICAgICAgJ0NhY2hlLUNvbnRyb2wnLFxyXG4gICAgICAgICduby1zdG9yZSwgbm8tY2FjaGUsIG11c3QtcmV2YWxpZGF0ZSwgcHJveHktcmV2YWxpZGF0ZScsXHJcbiAgICAgICk7XHJcbiAgICAgIHJlcy5zZXQoJ1ByYWdtYScsICduby1jYWNoZScpO1xyXG4gICAgICByZXMuc2V0KCdFeHBpcmVzJywgJzAnKTtcclxuICAgICAgcmV0dXJuIHJlcy5zZW5kKGJ1ZmZlcik7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAvLyBTdGlsbCByZXR1cm4gdGhlIHBpeGVsIGV2ZW4gaWYgdHJhY2tpbmcgZmFpbHNcclxuICAgICAgY29uc3QgYnVmZmVyID0gQnVmZmVyLmZyb20oXHJcbiAgICAgICAgJ1IwbEdPRGxoQVFBQkFJQUFBQUFBQVAvLy95SDVCQUVBQUFBQUxBQUFBQUFCQUFFQUFBSUJSQUE3JyxcclxuICAgICAgICAnYmFzZTY0JyxcclxuICAgICAgKTtcclxuXHJcbiAgICAgIHJlcy5zZXQoJ0NvbnRlbnQtVHlwZScsICdpbWFnZS9naWYnKTtcclxuICAgICAgcmV0dXJuIHJlcy5zZW5kKGJ1ZmZlcik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyBUaGlzIGVuZHBvaW50IHdvdWxkIGJlIHVzZWQgZm9yIHRyYWNraW5nIGVtYWlsIGNsaWNrc1xyXG4gIEBHZXQoJ3RyYWNrL2NsaWNrLzppZCcpXHJcbiAgYXN5bmMgdHJhY2tDbGljayhcclxuICAgIEBQYXJhbSgnaWQnKSBpZDogc3RyaW5nLFxyXG4gICAgQFF1ZXJ5KCd1cmwnKSB1cmw6IHN0cmluZyxcclxuICAgIEBSZXMoKSByZXMsXHJcbiAgKSB7XHJcbiAgICB0cnkge1xyXG4gICAgICAvLyBVcGRhdGUgdGhlIGVtYWlsIGxvZyB0byBtYXJrIGFzIGNsaWNrZWRcclxuICAgICAgYXdhaXQgdGhpcy5lbWFpbFNlcnZpY2UubWFya0VtYWlsQXNDbGlja2VkKGlkLCB1cmwpO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgLy8gTG9nIHRoZSBlcnJvciBidXQgY29udGludWUgd2l0aCB0aGUgcmVkaXJlY3RcclxuICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgdHJhY2tpbmcgY2xpY2s6JywgZXJyb3IpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFJlZGlyZWN0IHRvIHRoZSBvcmlnaW5hbCBVUkxcclxuICAgIHJldHVybiByZXMucmVkaXJlY3QodXJsKTtcclxuICB9XHJcbn1cclxuIl0sInZlcnNpb24iOjN9